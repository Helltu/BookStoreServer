
============================================================
FILE PATH: docker-compose.yml
============================================================

services:
    book-store-app:
      build: .
      ports:
        - "8080:8080"
      environment:
        - SPRING_PROFILES_ACTIVE=docker
      depends_on:
        mysql-db:
          condition: service_healthy
        elasticsearch:
          condition: service_started

    mysql-db:
      image: mysql:8.0
      ports:
        - "3306:3306"
      environment:
        - MYSQL_ROOT_PASSWORD=root
        - MYSQL_DATABASE=book_store
      volumes:
        - mysql-data:/var/lib/mysql
      healthcheck:
        test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
        interval: 10s
        timeout: 5s
        retries: 5

    elasticsearch:
      image: elasticsearch:8.11.1
      ports:
        - "9201:9200"
        - "9300:9300"
      environment:
        - discovery.type=single-node
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      volumes:
        - elasticsearch-data:/usr/share/elasticsearch/data

volumes:
  mysql-data:
  elasticsearch-data:

============================================================
FILE PATH: HELP.md
============================================================

# Read Me First
The following was discovered as part of building this project:

* The original package name 'com.bsuir.book-store' is invalid and this project uses 'com.bsuir.book_store' instead.

# Getting Started

### Reference Documentation
For further reference, please consider the following sections:

* [Official Apache Maven documentation](https://maven.apache.org/guides/index.html)
* [Spring Boot Maven Plugin Reference Guide](https://docs.spring.io/spring-boot/3.5.7/maven-plugin)
* [Create an OCI image](https://docs.spring.io/spring-boot/3.5.7/maven-plugin/build-image.html)
* [Spring Security](https://docs.spring.io/spring-boot/3.5.7/reference/web/spring-security.html)
* [Spring Web](https://docs.spring.io/spring-boot/3.5.7/reference/web/servlet.html)
* [Spring Data JPA](https://docs.spring.io/spring-boot/3.5.7/reference/data/sql.html#data.sql.jpa-and-spring-data)

### Guides
The following guides illustrate how to use some features concretely:

* [Securing a Web Application](https://spring.io/guides/gs/securing-web/)
* [Spring Boot and OAuth2](https://spring.io/guides/tutorials/spring-boot-oauth2/)
* [Authenticating a User with LDAP](https://spring.io/guides/gs/authenticating-ldap/)
* [Building a RESTful Web Service](https://spring.io/guides/gs/rest-service/)
* [Serving Web Content with Spring MVC](https://spring.io/guides/gs/serving-web-content/)
* [Building REST services with Spring](https://spring.io/guides/tutorials/rest/)
* [Accessing Data with JPA](https://spring.io/guides/gs/accessing-data-jpa/)
* [Accessing data with MySQL](https://spring.io/guides/gs/accessing-data-mysql/)

### Maven Parent overrides

Due to Maven's design, elements are inherited from the parent POM to the project POM.
While most of the inheritance is fine, it also inherits unwanted elements like `<license>` and `<developers>` from the parent.
To prevent this, the project POM contains empty overrides for these elements.
If you manually switch to a different parent and actually want the inheritance, you need to remove those overrides.



============================================================
FILE PATH: pom.xml
============================================================

<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.5.7</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.bsuir</groupId>
	<artifactId>book-store</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>book-store</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>21</java.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>com.mysql</groupId>
			<artifactId>mysql-connector-j</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-elasticsearch</artifactId>
		</dependency>
		<dependency>
			<groupId>dev.langchain4j</groupId>
			<artifactId>langchain4j-spring-boot-starter</artifactId>
			<version>0.35.0</version>
		</dependency>
		<dependency>
			<groupId>dev.langchain4j</groupId>
			<artifactId>langchain4j-open-ai</artifactId>
			<version>0.35.0</version>
		</dependency>
		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.8.14</version>
		</dependency>
		<dependency>
			<groupId>com.h2database</groupId>
			<artifactId>h2</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-test</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
							<version>1.18.42</version>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>


============================================================
FILE PATH: README.md
============================================================

# BookStoreServer

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\BookStoreApplication.java
============================================================

package com.bsuir.book_store;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class BookStoreApplication {

	public static void main(String[] args) {
		SpringApplication.run(BookStoreApplication.class, args);
	}

}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\analytics\api\AnalyticsController.java
============================================================

package com.bsuir.book_store.analytics.api;

import com.bsuir.book_store.analytics.api.dto.AnalyticsResponse;
import com.bsuir.book_store.analytics.application.AnalyticsService;
import com.bsuir.book_store.shared.security.annotations.IsManager;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/analytics")
@RequiredArgsConstructor
@Tag(name = "Analytics", description = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂")
public class AnalyticsController {

    private final AnalyticsService analyticsService;

    @Operation(
            summary = "–ü–æ–ª—É—á–∏—Ç—å –¥–∞—à–±–æ—Ä–¥",
            description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º, —Ç–æ–ø –∫–Ω–∏–≥ –∏ –≥—Ä–∞—Ñ–∏–∫–∏. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ MANAGER."
    )
    @GetMapping
    @IsManager
    public ResponseEntity<AnalyticsResponse> getDashboard() {
        return ResponseEntity.ok(analyticsService.getDashboardData());
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\analytics\api\dto\AnalyticsResponse.java
============================================================

package com.bsuir.book_store.analytics.api.dto;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
public class AnalyticsResponse {
    private Summary summary;

    private List<DatePoint> salesOverTime;

    private List<CategoryPoint> salesByCategory;

    private List<BookPoint> topSellingBooks;

    @Data
    @Builder
    public static class Summary {
        private long totalOrders;
        private BigDecimal totalRevenue;
        private long totalBooksSold;
        private double averageCheck;
    }

    @Data
    @Builder
    public static class DatePoint {
        private String date;
        private BigDecimal value;
    }

    @Data
    @Builder
    public static class CategoryPoint {
        private String category;
        private long count;
    }

    @Data
    @Builder
    public static class BookPoint {
        private String title;
        private long soldCount;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\analytics\application\AnalyticsService.java
============================================================

package com.bsuir.book_store.analytics.application;

import com.bsuir.book_store.analytics.api.dto.AnalyticsResponse;
import com.bsuir.book_store.orders.domain.Order;
import com.bsuir.book_store.orders.domain.OrderItem;
import com.bsuir.book_store.orders.domain.OrderStatus;
import com.bsuir.book_store.orders.infrastructure.OrderRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class AnalyticsService {

    private final OrderRepository orderRepository;

    @Transactional(readOnly = true)
    public AnalyticsResponse getDashboardData() {
        List<Order> orders = orderRepository.findAll().stream()
                .filter(o -> o.getStatus() != OrderStatus.CANCELLED)
                .toList();

        long totalOrders = orders.size();
        BigDecimal totalRevenue = orders.stream()
                .map(Order::getTotalCost) // –í –≤–∞—à–µ–π —Å—É—â–Ω–æ—Å—Ç–∏ Order –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è totalCost
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        long totalBooksSold = orders.stream()
                .flatMap(o -> o.getOrderItems().stream())
                .mapToLong(OrderItem::getQuantity)
                .sum();

        double averageCheck = totalOrders > 0
                ? totalRevenue.divide(BigDecimal.valueOf(totalOrders), 2, RoundingMode.HALF_UP).doubleValue()
                : 0.0;

        // 3. –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂ –ø–æ –¥–∞—Ç–∞–º (Sales Over Time)
        Map<LocalDate, BigDecimal> revenueByDate = orders.stream()
                .collect(Collectors.groupingBy(
                        order -> order.getCreatedAt().toLocalDateTime().toLocalDate(),
                        Collectors.reducing(BigDecimal.ZERO, Order::getTotalCost, BigDecimal::add)
                ));

        List<AnalyticsResponse.DatePoint> salesOverTime = revenueByDate.entrySet().stream()
                .sorted(Map.Entry.comparingByKey())
                .map(entry -> AnalyticsResponse.DatePoint.builder()
                        .date(entry.getKey().format(DateTimeFormatter.ISO_DATE))
                        .value(entry.getValue())
                        .build())
                .toList();

        List<OrderItem> allItems = orders.stream()
                .flatMap(o -> o.getOrderItems().stream())
                .toList();

        Map<String, Long> categoryStats = allItems.stream()
                .flatMap(item -> item.getBook().getGenres().stream())
                .collect(Collectors.groupingBy(
                        genre -> genre.getName(),
                        Collectors.counting()
                ));

        List<AnalyticsResponse.CategoryPoint> salesByCategory = categoryStats.entrySet().stream()
                .map(entry -> AnalyticsResponse.CategoryPoint.builder()
                        .category(entry.getKey())
                        .count(entry.getValue())
                        .build())
                .toList();

        // 5. –¢–æ–ø –ø—Ä–æ–¥–∞–≤–∞–µ–º—ã—Ö –∫–Ω–∏–≥
        Map<String, Long> bookStats = allItems.stream()
                .collect(Collectors.groupingBy(
                        item -> item.getBookTitle(), // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        Collectors.summingLong(OrderItem::getQuantity)
                ));

        List<AnalyticsResponse.BookPoint> topBooks = bookStats.entrySet().stream()
                .sorted(Map.Entry.<String, Long>comparingByValue().reversed())
                .limit(5) // –¢–æ–ø-5
                .map(entry -> AnalyticsResponse.BookPoint.builder()
                        .title(entry.getKey())
                        .soldCount(entry.getValue())
                        .build())
                .toList();

        return AnalyticsResponse.builder()
                .summary(AnalyticsResponse.Summary.builder()
                        .totalOrders(totalOrders)
                        .totalRevenue(totalRevenue)
                        .totalBooksSold(totalBooksSold)
                        .averageCheck(averageCheck)
                        .build())
                .salesOverTime(salesOverTime)
                .salesByCategory(salesByCategory)
                .topSellingBooks(topBooks)
                .build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\api\ChatController.java
============================================================

package com.bsuir.book_store.assistant.api;

import com.bsuir.book_store.assistant.api.dto.ChatRequest;
import com.bsuir.book_store.assistant.api.dto.ChatResponse;
import com.bsuir.book_store.assistant.application.BookStoreAssistant;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/chat")
@RequiredArgsConstructor
@Tag(name = "AI Assistant", description = "–ß–∞—Ç —Å —É–º–Ω—ã–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º")
public class ChatController {

    private final BookStoreAssistant assistant;

    @Operation(summary = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", description = "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ LLM (OpenAI)")
    @PostMapping
    public ResponseEntity<ChatResponse> chat(
            @RequestBody ChatRequest request,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        String aiResponse = assistant.chat(userDetails.getUsername(), request.getMessage());

        return ResponseEntity.ok(new ChatResponse(aiResponse));
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\api\dto\ChatRequest.java
============================================================

package com.bsuir.book_store.assistant.api.dto;
import lombok.Data;

@Data
public class ChatRequest {
    private String message;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\api\dto\ChatResponse.java
============================================================

package com.bsuir.book_store.assistant.api.dto;
import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class ChatResponse {
    private String response;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\application\BookStoreAssistant.java
============================================================

package com.bsuir.book_store.assistant.application;

import dev.langchain4j.service.SystemMessage;
import dev.langchain4j.service.UserMessage;
import dev.langchain4j.service.V;

public interface BookStoreAssistant {

    @SystemMessage("""
            ### –†–û–õ–¨ –ò –¶–ï–õ–¨
            –¢—ã ‚Äî **–ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç** —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫–Ω–∏–∂–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ "BookStore".
            –í –Ω–∞—à–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–Ω–∏–≥–∏ –Ω–∞ **—Ä—É—Å—Å–∫–æ–º, –±–µ–ª–æ—Ä—É—Å—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–∞—Ö**.
            –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω—É—é –∫–Ω–∏–≥—É, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –Ω–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –æ–Ω–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ –∏–ª–∏ –∏–∑–¥–∞–Ω–∞.

            ### –ö–û–ù–¢–ï–ö–°–¢ –ò –û–°–û–ë–ï–ù–ù–û–°–¢–ò –ü–û–ò–°–ö–ê
            1. **–í—Ö–æ–¥—è—â–∏–π —è–∑—ã–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±—ã—á–Ω–æ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –Ω–æ –º–æ–≥—É—Ç –∏—Å–∫–∞—Ç—å –∫–Ω–∏–≥–∏ –Ω–∞ –±–µ–ª–æ—Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.
            2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** –°–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –∫–Ω–∏–≥ –Ω–∞ —è–∑—ã–∫–µ –∏–∑–¥–∞–Ω–∏—è (RU, BE, EN).
            3. **–¢–≤–æ—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∏—Å–∫–∞ (Tools):**
               - **–ù–µ –ø–µ—Ä–µ–≤–æ–¥–∏ –≤—Å—ë –ø–æ–¥—Ä—è–¥.** –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
               - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç *—Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É* –∏ –ø–∏—à–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º -> –∏—â–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
               - –ï—Å–ª–∏ –∏—â—É—Ç *—Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É* (IT, –Ω–∞—É–∫–∞) -> –∏—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º (—á–∞—Å—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—ã –ª—É—á—à–µ).
               - –ï—Å–ª–∏ –∏—â—É—Ç *–±–µ–ª–æ—Ä—É—Å—Å–∫—É—é –∫–ª–∞—Å—Å–∏–∫—É* -> –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–±—É–π –∏—Å–∫–∞—Ç—å –Ω–∞ –±–µ–ª–æ—Ä—É—Å—Å–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ö–∞—Ä–∞—Ç–∫–µ–≤—ñ—á", "–ë—ã–∫–∞—û").
               - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—Ç–æ—á–Ω–∏–ª —è–∑—ã–∫ –∫–Ω–∏–≥–∏, —Å—Ç–∞—Ä–∞–π—Å—è –Ω–∞–π—Ç–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ —è–∑—ã–∫–µ –∑–∞–ø—Ä–æ—Å–∞, –Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫—Ä—É—Ç–æ–π –±–µ—Å—Ç—Å–µ–ª–ª–µ—Ä –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ IT), –ø—Ä–µ–¥–ª–æ–∂–∏ –∏ –µ–≥–æ.

            ### –ê–õ–ì–û–†–ò–¢–ú –†–ê–ë–û–¢–´
            1. **–ê–Ω–∞–ª–∏–∑:** –ü–æ–π–º–∏, —á—Ç–æ –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–Ω–∏–≥—É, –∂–∞–Ω—Ä –∏–ª–∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.
            2. **–ü–æ–∏—Å–∫:** –°—Ñ–æ—Ä–º–∏—Ä—É–π –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è Tools.
               *–ü—Ä–∏–º–µ—Ä 1:* "–ö–Ω–∏–≥–∏ –ø–æ Java" -> –ò—â–∏ "Java", "Spring", "Java –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö".
               *–ü—Ä–∏–º–µ—Ä 2:* "–í–µ—Ä—à—ã –±–µ–ª–∞—Ä—É—Å–∫—ñ—Ö –ø–∞—ç—Ç–∞—û" -> –ò—â–∏ "–í–µ—Ä—à—ã", "–ë–∞–≥–¥–∞–Ω–æ–≤—ñ—á", "–ü–∞—ç–∑—ñ—è".
               *–ü—Ä–∏–º–µ—Ä 3:* "–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä" -> –ò—â–∏ "–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä" (RU) –∏, –≤–æ–∑–º–æ–∂–Ω–æ, "Harry Potter" (EN), –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ñ–∞–Ω–∞—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–≤.
            3. **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –†–µ–∫–æ–º–µ–Ω–¥—É–π —Ç–æ–ª—å–∫–æ —Ç–µ –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –≤–µ—Ä–Ω—É–ª–∏—Å—å –∏–∑ –ø–æ–∏—Å–∫–∞. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π.
            4. **–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è:** –†–∞—Å—Å–∫–∞–∂–∏ –æ –∫–Ω–∏–≥–∞—Ö –Ω–∞ —è–∑—ã–∫–µ –æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–æ–±—ã—á–Ω–æ —Ä—É—Å—Å–∫–∏–π), –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è.

            ### –ü–†–ê–í–ò–õ–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø –û–¢–í–ï–¢–ê
            –ò—Å–ø–æ–ª—å–∑—É–π **Markdown** –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏:

            ---
            **üìö [–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ —Ç–∞–∫, –∫–∞–∫ –æ–Ω–æ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –±–∞–∑–µ]**
            *–ê–≤—Ç–æ—Ä: [–ò–º—è –ê–≤—Ç–æ—Ä–∞]*
            *–Ø–∑—ã–∫: [–£–∫–∞–∂–∏ —è–∑—ã–∫ –∫–Ω–∏–≥–∏: RU/BE/EN]*

            **üí∞ –¶–µ–Ω–∞:** [–¶–µ–Ω–∞] BYN

            **–û —á–µ–º —ç—Ç–∞ –∫–Ω–∏–≥–∞:**
            [–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—É—Ç–∏. –ï—Å–ª–∏ –∫–Ω–∏–≥–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º/–±–µ–ª–æ—Ä—É—Å—Å–∫–æ–º, –æ–ø–∏—à–∏ –µ—ë —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ.]

            **–ü–æ—á–µ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥—É—é:**
            [–ß–µ–º —ç—Ç–∞ –∫–Ω–∏–≥–∞ —Ö–æ—Ä–æ—à–∞ –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.]
            ---

            ### –í–ê–ñ–ù–´–ï –£–ö–ê–ó–ê–ù–ò–Ø
            - **–í–∞–ª—é—Ç–∞:** –í—Å–µ —Ü–µ–Ω—ã —Å—Ç—Ä–æ–≥–æ –≤ **BYN**.
            - **–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å:** –ù–µ –±–æ–π—Å—è –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∫–Ω–∏–≥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–ª—è IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –∏–ª–∏ –Ω–∞ –±–µ–ª–æ—Ä—É—Å—Å–∫–æ–º –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π –∏—Å—Ç–æ—Ä–∏–∏/–∫—É–ª—å—Ç—É—Ä—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ù–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–π –æ —è–∑—ã–∫–µ –∫–Ω–∏–≥–∏.
            - **–°—Ç–∏–ª—å:** –í–µ–∂–ª–∏–≤—ã–π, –ø–æ–º–æ–≥–∞—é—â–∏–π, —ç—Ä—É–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π.

            ### –ü–†–ò–ú–ï–†–´ –î–ò–ê–õ–û–ì–û–í
            User: "–ù—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —É—Ä–æ–≤–µ–Ω—å B1."
            Thought: –ò—â—É —É—á–µ–±–Ω–∏–∫–∏ –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É. Keywords: "English Grammar", "Adapted readers", "English B1".
            Response: (–ü—Ä–µ–¥–ª–∞–≥–∞–µ—à—å "English Grammar in Use" –∏–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ "Sherlock Holmes").

            User: "–•–æ—á—É –ø–∞—á—ã—Ç–∞—Ü—å –Ω–µ—à—Ç–∞ –∑ –∫–ª–∞—Å—ñ–∫—ñ."
            Thought: –ó–∞–ø—Ä–æ—Å –Ω–∞ –±–µ–ª–æ—Ä—É—Å—Å–∫–æ–º/—Ç—Ä–∞—Å—è–Ω–∫–µ. –ò—â—É –±–µ–ª–æ—Ä—É—Å—Å–∫—É—é –∫–ª–∞—Å—Å–∏–∫—É: "–ö–∞–ª–∞—Å—ã –ø–∞–¥ —Å—è—Ä–ø–æ–º —Ç–≤–∞—ñ–º", "–õ—é–¥–∑—ñ –Ω–∞ –±–∞–ª–æ—Ü–µ".
            Response: (–û—Ç–≤–µ—á–∞–µ—à—å, –ø—Ä–µ–¥–ª–∞–≥–∞—è –±–µ–ª–æ—Ä—É—Å—Å–∫–∏–µ –∫–Ω–∏–≥–∏ —Å —Ü–µ–Ω–∞–º–∏ –≤ BYN).

            User: "–ü–æ—Å–æ–≤–µ—Ç—É–π –∫–Ω–∏–≥—É –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º."
            Thought: IT-–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞. –ò—â—É: "Grokking Algorithms" (EN/RU), "Algorithms" (EN), "–ê–ª–≥–æ—Ä–∏—Ç–º—ã" (RU).
            Response: (–ü—Ä–µ–¥–ª–∞–≥–∞–µ—à—å "–ì—Ä–æ–∫–∞–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º—ã" –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏ "Introduction to Algorithms" –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –¥–∞–≤–∞—è –≤—ã–±–æ—Ä).
            """)
    String chat(@V("username") String username, @UserMessage String userMessage);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\infrastructure\config\AssistantConfig.java
============================================================

package com.bsuir.book_store.assistant.infrastructure.config;

import com.bsuir.book_store.assistant.application.BookStoreAssistant;
import com.bsuir.book_store.assistant.infrastructure.tools.CatalogAiTools;
import com.bsuir.book_store.assistant.infrastructure.tools.OrderAiTools;
import dev.langchain4j.memory.chat.ChatMemoryProvider;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.openai.OpenAiChatModel;
import dev.langchain4j.service.AiServices;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.time.Duration;

@Configuration
public class AssistantConfig {

    @Bean
    public ChatLanguageModel chatLanguageModel() {
        return OpenAiChatModel.builder()
                .baseUrl("http://langchain4j.dev/demo/openai/v1")
                .apiKey("demo")
                .modelName("gpt-4o-mini")
                .timeout(Duration.ofSeconds(60))
                .logRequests(true)
                .logResponses(true)
                .build();
    }

    @Bean
    public ChatMemoryProvider chatMemoryProvider() {
        return chatId -> MessageWindowChatMemory.withMaxMessages(10);
    }

    @Bean
    public BookStoreAssistant bookStoreAssistant(
            ChatLanguageModel chatLanguageModel,
            CatalogAiTools catalogAiTools,
            OrderAiTools orderAiTools,
            ChatMemoryProvider chatMemoryProvider
    ) {
        return AiServices.builder(BookStoreAssistant.class)
                .chatLanguageModel(chatLanguageModel)
                .chatMemoryProvider(chatMemoryProvider)
                .tools(catalogAiTools, orderAiTools)
                .build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\infrastructure\tools\CatalogAiTools.java
============================================================

package com.bsuir.book_store.assistant.infrastructure.tools;

import com.bsuir.book_store.catalog.application.CatalogQueryService;
import com.bsuir.book_store.catalog.domain.document.BookDocument;
import dev.langchain4j.agent.tool.Tool;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Slf4j
@Component
@RequiredArgsConstructor
public class CatalogAiTools {

    private final CatalogQueryService catalogQueryService;

    // –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –±–µ–ª–æ—Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤ (—û, —ñ, –∞–ø–æ—Å—Ç—Ä–æ—Ñ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ)
    private static final Pattern BELARUSIAN_PATTERN = Pattern.compile("[—û–é—ñ–Ü']");
    // –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ —Ü–µ–ª–æ–º
    private static final Pattern CYRILLIC_PATTERN = Pattern.compile("\\p{IsCyrillic}");

    @Tool("""
          –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥. 
          –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–∞–º —Ä–µ—à–∞—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –∏—Å–∫–∞—Ç—å, –∏—Å—Ö–æ–¥—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞.
          
          –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ:
          1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–Ω–∏–≥—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º/–±–µ–ª–æ—Ä—É—Å—Å–∫–æ–º -> –ø–µ—Ä–µ–¥–∞–≤–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–∫ –µ—Å—Ç—å.
          2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç IT-–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É –∏–ª–∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –±–µ—Å—Ç—Å–µ–ª–ª–µ—Ä -> –ø–æ–ø—Ä–æ–±—É–π –Ω–∞–π—Ç–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –ò–õ–ò –ø–µ—Ä–µ–≤–æ–¥.
          3. –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–∞–ª–æ -> –ø–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞.
          """)
    public String searchBooks(String query) {
        log.info("AI tool [searchBooks] called with query: '{}'", query);

        List<BookDocument> results = catalogQueryService.search(query);

        if (results.isEmpty()) {
            return String.format("–ü–æ –∑–∞–ø—Ä–æ—Å—É '%s' –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π) –∏–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –µ–≥–æ.", query);
        }

        return results.stream()
                .limit(7)
                .map(b -> {
                    String language = detectRealLanguage(b); // –†–µ–∞–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞
                    return String.format("ID: %s | –ù–∞–∑–≤–∞–Ω–∏–µ: %s | –ê–≤—Ç–æ—Ä: %s | –Ø–∑—ã–∫ –∏–∑–¥–∞–Ω–∏—è: %s | –¶–µ–Ω–∞: %s BYN | –û–ø–∏—Å–∞–Ω–∏–µ: %s",
                            b.getId(),
                            b.getTitle(),
                            String.join(", ", b.getAuthors()),
                            language,
                            b.getPrice(),
                            truncate(b.getDescription(), 120));
                })
                .collect(Collectors.joining("\n---\n"));
    }

    @Tool("""
          –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∫–Ω–∏–≥–∏ –ø–æ ID (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ) –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é.
          –í—ã–∑—ã–≤–∞–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –¥–∞—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–Ω–∏–≥–µ.
          """)
    public String getBookDetails(String idOrTitle) {
        log.info("AI tool [getBookDetails] called with: '{}'", idOrTitle);

        List<BookDocument> results = catalogQueryService.search(idOrTitle);

        if (results.isEmpty()) {
            return "–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å ID.";
        }

        BookDocument book = results.get(0);
        String language = detectRealLanguage(book);

        return String.format("""
                --- –ü–û–î–†–û–ë–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ---
                ID: %s
                –ù–∞–∑–≤–∞–Ω–∏–µ: %s
                –ê–≤—Ç–æ—Ä(—ã): %s
                –ñ–∞–Ω—Ä—ã: %s
                –Ø–∑—ã–∫ –∏–∑–¥–∞–Ω–∏—è: %s
                –¶–µ–Ω–∞: %s BYN
                
                –ü–æ–ª–Ω–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è:
                %s
                ----------------------------
                """,
                book.getId(),
                book.getTitle(),
                String.join(", ", book.getAuthors()),
                String.join(", ", book.getGenres()),
                language,
                book.getPrice(),
                book.getDescription()
        );
    }

    private String truncate(String text, int length) {
        if (text == null || text.isBlank()) return "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è";
        return text.length() > length ? text.substring(0, length) + "..." : text;
    }

    private String detectRealLanguage(BookDocument book) {
        // –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        String textToAnalyze = (book.getTitle() + " " + book.getDescription()).toLowerCase();

        if (BELARUSIAN_PATTERN.matcher(textToAnalyze).find()) {
            return "BELARUSIAN (BY)";
        }

        if (CYRILLIC_PATTERN.matcher(textToAnalyze).find()) {
            return "RUSSIAN (RU)";
        }

        return "ENGLISH (EN)";
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\infrastructure\tools\OrderAiTools.java
============================================================

package com.bsuir.book_store.assistant.infrastructure.tools;

import com.bsuir.book_store.orders.application.OrderService;
import com.bsuir.book_store.orders.domain.Order;
import dev.langchain4j.agent.tool.Tool;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.stream.Collectors;

@Component
@RequiredArgsConstructor
public class OrderAiTools {

    private final OrderService orderService;

    @Tool("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
    public String getMyLastOrders(String username) {
        try {
            List<Order> orders = orderService.getMyOrders(username);
            if (orders.isEmpty()) {
                return "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.";
            }

            return orders.stream()
                    .limit(3)
                    .map(o -> String.format("–ó–∞–∫–∞–∑ %s –æ—Ç %s. –°—Ç–∞—Ç—É—Å: %s. –°—É–º–º–∞: %s BYN",
                            o.getOrderNumber(),
                            o.getOrderDate(),
                            o.getStatus(),
                            o.getTotalCost()))
                    .collect(Collectors.joining("\n"));
        } catch (Exception e) {
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.";
        }
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\api\CatalogController.java
============================================================

package com.bsuir.book_store.catalog.api;

import com.bsuir.book_store.catalog.api.dto.CreateBookRequest;
import com.bsuir.book_store.catalog.api.dto.ImportBookRequest;
import com.bsuir.book_store.catalog.application.CatalogCommandService;
import com.bsuir.book_store.catalog.application.CatalogQueryService;
import com.bsuir.book_store.catalog.application.ImportBookService;
import com.bsuir.book_store.catalog.domain.document.BookDocument;
import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.shared.security.annotations.IsManager;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/api/catalog")
@RequiredArgsConstructor
@Tag(name = "Catalog", description = "–ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–æ–º")
public class CatalogController {

    private final ImportBookService importBookService;
    private final CatalogCommandService commandService;
    private final CatalogQueryService queryService;

    @Operation(summary = "–ò–º–ø–æ—Ä—Ç –∫–Ω–∏–≥–∏ (–ú–µ–Ω–µ–¥–∂–µ—Ä)", description = "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ –∏–∑ Google Books API –ø–æ ISBN")
    @PostMapping("/import")
    @IsManager
    public ResponseEntity<String> importBookFromExternalApi(@RequestBody ImportBookRequest request) {
        Book importedBook = importBookService.importBook(
                request.getIsbn(),
                request.getPrice(),
                request.getStock()
        );
        return ResponseEntity.ok("–ö–Ω–∏–≥–∞ '" + importedBook.getTitle() + "' —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å ID: " + importedBook.getId());
    }

    @Operation(summary = "–ü–æ–∏—Å–∫ –∫–Ω–∏–≥", description = "–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Elasticsearch (–ù–∞–∑–≤–∞–Ω–∏–µ, –ê–≤—Ç–æ—Ä, –û–ø–∏—Å–∞–Ω–∏–µ)")
    @GetMapping("/search")
    public ResponseEntity<List<BookDocument>> search(@RequestParam(required = false) String q) {
        return ResponseEntity.ok(queryService.search(q));
    }

    @Operation(summary = "–°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–∏–≥–∏", description = "–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∫–Ω–∏–≥—É –ø–æ –≤–≤–µ–¥–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º")
    @PostMapping("/books")
    @IsManager
    public ResponseEntity<UUID> createBook(@RequestBody CreateBookRequest request) {
        return ResponseEntity.ok(commandService.createBook(request));
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\api\dto\CreateBookRequest.java
============================================================

package com.bsuir.book_store.catalog.api.dto;

import lombok.Data;
import java.math.BigDecimal;
import java.util.List;
import java.util.UUID;

@Data
public class CreateBookRequest {
    private String title;
    private String description;
    private String isbn;
    private BigDecimal price;
    private int stock;
    private List<UUID> authorIds;
    private List<UUID> genreIds;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\api\dto\ImportBookRequest.java
============================================================

package com.bsuir.book_store.catalog.api.dto;

import lombok.Data;
import java.math.BigDecimal;

@Data
public class ImportBookRequest {
    private String isbn;
    private BigDecimal price;
    private int stock;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\application\CatalogCommandService.java
============================================================

package com.bsuir.book_store.catalog.application;

import com.bsuir.book_store.catalog.api.dto.CreateBookRequest;
import com.bsuir.book_store.catalog.application.sync.SearchSyncService;
import com.bsuir.book_store.catalog.domain.model.Author;
import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.domain.model.Genre;
import com.bsuir.book_store.catalog.infrastructure.AuthorRepository;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.catalog.infrastructure.GenreRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class CatalogCommandService {

    private final BookRepository bookRepository;
    private final AuthorRepository authorRepository;
    private final GenreRepository genreRepository;
    private final SearchSyncService searchSyncService;

    @Transactional
    public UUID createBook(CreateBookRequest request) {
        Set<Author> authors = new HashSet<>(authorRepository.findAllById(request.getAuthorIds()));
        Set<Genre> genres = new HashSet<>(genreRepository.findAllById(request.getGenreIds()));

        // 2. –°–æ–∑–¥–∞–µ–º —Å—É—â–Ω–æ—Å—Ç—å (Rich Model)
        Book book = Book.builder()
                .title(request.getTitle())
                .description(request.getDescription())
                .isbn(request.getIsbn())
                .cost(request.getPrice())
                .stockQuantity(request.getStock())
                .authors(authors)
                .genres(genres)
                .build();

        book = bookRepository.save(book);

        searchSyncService.syncBook(book);

        return book.getId();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\application\CatalogQueryService.java
============================================================

package com.bsuir.book_store.catalog.application;

import com.bsuir.book_store.catalog.domain.document.BookDocument;
import com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class CatalogQueryService {

    private final BookElasticRepository elasticRepository;

    public List<BookDocument> search(String query) {
        if (query == null || query.isBlank()) {
            List<BookDocument> result = new ArrayList<>();
            elasticRepository.findAll().forEach(result::add);
            return result;
        }

        return elasticRepository.searchByComplexQuery(query);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\application\ImportBookService.java
============================================================

package com.bsuir.book_store.catalog.application;

import com.bsuir.book_store.catalog.application.sync.SearchSyncService;
import com.bsuir.book_store.catalog.domain.model.Author;
import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.domain.model.Genre;
import com.bsuir.book_store.catalog.domain.model.Image;
import com.bsuir.book_store.catalog.domain.model.ImageType;
import com.bsuir.book_store.catalog.infrastructure.external.google.GoogleBooksClient;
import com.bsuir.book_store.catalog.infrastructure.external.google.GoogleBooksClient.GoogleBookDto;
import com.bsuir.book_store.catalog.infrastructure.AuthorRepository;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.catalog.infrastructure.GenreRepository;
import com.bsuir.book_store.catalog.infrastructure.ImageRepository;
import com.bsuir.book_store.shared.exception.DomainException;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.HashSet;
import java.util.Set;

@Service
@RequiredArgsConstructor
public class ImportBookService {

    private final GoogleBooksClient googleBooksClient;
    private final BookRepository bookRepository;
    private final AuthorRepository authorRepository;
    private final GenreRepository genreRepository;
    private final ImageRepository imageRepository;
    private final SearchSyncService searchSyncService;

    @Transactional
    public Book importBook(String isbn, BigDecimal defaultPrice, int defaultStock) {
        if (bookRepository.existsByIsbn(isbn)) {
            throw new DomainException("–ö–Ω–∏–≥–∞ —Å ISBN " + isbn + " —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ");
        }

        GoogleBookDto googleBook = googleBooksClient.fetchBookByIsbn(isbn);

        Set<Author> authors = new HashSet<>();
        if (googleBook.getAuthors() != null) {
            for (String authorName : googleBook.getAuthors()) {
                Author author = authorRepository.findByName(authorName)
                        .orElseGet(() -> authorRepository.save(
                                Author.builder().name(authorName).build()
                        ));
                authors.add(author);
            }
        }

        Set<Genre> genres = new HashSet<>();
        if (googleBook.getCategories() != null) {
            for (String categoryName : googleBook.getCategories()) {
                Genre genre = genreRepository.findByName(categoryName)
                        .orElseGet(() -> genreRepository.save(
                                Genre.builder().name(categoryName).build()
                        ));
                genres.add(genre);
            }
        }

        if (googleBook.getImageLinks() != null && googleBook.getImageLinks().getThumbnail() != null) {
            Image cover = Image.builder()
                    .url(googleBook.getImageLinks().getThumbnail())
                    .imageType(ImageType.COVER)
                    .build();
            imageRepository.save(cover);
        }

        Book book = Book.builder()
                .title(googleBook.getTitle())
                .description(googleBook.getDescription())
                .isbn(isbn)
                .cost(defaultPrice)
                .stockQuantity(defaultStock)
                .authors(authors)
                .genres(genres)
                .build();

        book = bookRepository.save(book);
        searchSyncService.syncBook(book);

        return book;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\application\sync\SearchSyncService.java
============================================================

package com.bsuir.book_store.catalog.application.sync;

import com.bsuir.book_store.catalog.domain.document.BookDocument;
import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
public class SearchSyncService {

    private final BookElasticRepository elasticRepository;

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void syncBook(Book book) {
        BookDocument doc = BookDocument.builder()
                .id(book.getId().toString())
                .title(book.getTitle())
                .description(book.getDescription())
                .isbn(book.getIsbn())
                .price(book.getCost())
                .authors(book.getAuthors().stream().map(a -> a.getName()).toList())
                .genres(book.getGenres().stream().map(g -> g.getName()).toList())
                .build();

        elasticRepository.save(doc);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\document\BookDocument.java
============================================================

package com.bsuir.book_store.catalog.domain.document;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.elasticsearch.annotations.Document;
import org.springframework.data.elasticsearch.annotations.Field;
import org.springframework.data.elasticsearch.annotations.FieldType;

import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
@Document(indexName = "books")
public class BookDocument {

    @Id
    private String id;

    @Field(type = FieldType.Text, analyzer = "standard")
    private String title;

    @Field(type = FieldType.Text)
    private String description;

    @Field(type = FieldType.Keyword)
    private String isbn;

    @Field(type = FieldType.Double)
    private BigDecimal price;

    @Field(type = FieldType.Text)
    private List<String> authors;

    @Field(type = FieldType.Keyword)
    private List<String> genres;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Author.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import jakarta.persistence.*;
import lombok.*;
import java.util.UUID;

@Entity
@Table(name = "authors")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Author {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String name;

    @Column(columnDefinition = "TEXT")
    private String biography;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Book.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import com.bsuir.book_store.shared.exception.DomainException;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.math.BigDecimal;
import java.sql.Timestamp;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

@Entity
@Table(name = "books")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Book {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String title;

    @Column(unique = true)
    private String isbn;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column(name = "stock_quantity", nullable = false)
    private int stockQuantity;

    @Column(nullable = false)
    private BigDecimal cost;

    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
            name = "book_authors",
            joinColumns = @JoinColumn(name = "book_id"),
            inverseJoinColumns = @JoinColumn(name = "author_id")
    )
    private Set<Author> authors = new HashSet<>();

    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
            name = "book_genres",
            joinColumns = @JoinColumn(name = "book_id"),
            inverseJoinColumns = @JoinColumn(name = "genre_id")
    )
    private Set<Genre> genres = new HashSet<>();

    @CreationTimestamp
    private Timestamp createdAt;

    @UpdateTimestamp
    private Timestamp updatedAt;

    public void reserveStock(int quantity) {
        if (quantity <= 0) throw new DomainException("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º");
        if (this.stockQuantity < quantity) {
            throw new DomainException("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ '" + title + "' –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: " + stockQuantity);
        }
        this.stockQuantity -= quantity;
    }

    public void releaseStock(int quantity) {
        this.stockQuantity += quantity;
    }

    public void updatePrice(BigDecimal newPrice) {
        if (newPrice.compareTo(BigDecimal.ZERO) < 0) throw new DomainException("–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π");
        this.cost = newPrice;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Genre.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import jakarta.persistence.*;
import lombok.*;
import java.util.UUID;

@Entity
@Table(name = "genres")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Genre {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String name;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Image.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.CreationTimestamp;
import java.sql.Timestamp;
import java.util.UUID;

@Entity
@Table(name = "images")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Image {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String url;

    @Enumerated(EnumType.STRING)
    @Column(name = "image_type")
    private ImageType imageType;

    @CreationTimestamp
    @Column(name = "created_at")
    private Timestamp createdAt;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\ImageType.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

public enum ImageType {
    COVER,
    ILLUSTRATION,
    AUTHOR_PHOTO,
    LOGO
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Publisher.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import jakarta.persistence.*;
import lombok.*;
import java.util.UUID;

@Entity
@Table(name = "publishers")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Publisher {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String name;

    @Column(columnDefinition = "TEXT")
    private String description;

    @ManyToOne
    @JoinColumn(name = "logo_image_id")
    private Image logo;
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\AuthorRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Author;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;
import java.util.UUID;

public interface AuthorRepository extends JpaRepository<Author, UUID> {
    Optional<Author> findByName(String name);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\BookRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Book;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.UUID;

public interface BookRepository extends JpaRepository<Book, UUID> {
    boolean existsByIsbn(String isbn);
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\GenreRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Genre;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;
import java.util.UUID;

public interface GenreRepository extends JpaRepository<Genre, UUID> {
    Optional<Genre> findByName(String name);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\ImageRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Image;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.UUID;

public interface ImageRepository extends JpaRepository<Image, UUID> {
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\PublisherRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Publisher;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.UUID;

public interface PublisherRepository extends JpaRepository<Publisher, UUID> {
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\elastic\BookElasticRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure.elastic;


import org.springframework.data.elasticsearch.annotations.Query;
import com.bsuir.book_store.catalog.domain.document.BookDocument;
import org.springframework.data.elasticsearch.repository.ElasticsearchRepository;
import java.util.List;

public interface BookElasticRepository extends ElasticsearchRepository<BookDocument, String> {
    @Query("{\"multi_match\": {\"query\": \"?0\", \"fields\": [\"title^3\", \"authors^2\", \"description\"], \"fuzziness\": \"AUTO\"}}")
    List<BookDocument> searchByComplexQuery(String query);
    List<BookDocument> findByGenresIn(List<String> genres);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\external\google\GoogleBooksClient.java
============================================================

package com.bsuir.book_store.catalog.infrastructure.external.google;

import com.bsuir.book_store.shared.exception.DomainException;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.util.List;

@Component
@RequiredArgsConstructor
public class GoogleBooksClient {

    private final RestTemplate restTemplate = new RestTemplate();
    private static final String GOOGLE_BOOKS_API_URL = "https://www.googleapis.com/books/v1/volumes?q=isbn:";

    public GoogleBookDto fetchBookByIsbn(String isbn) {
        String url = GOOGLE_BOOKS_API_URL + isbn;

        try {
            GoogleResponse response = restTemplate.getForObject(url, GoogleResponse.class);

            if (response == null || response.getItems() == null || response.getItems().isEmpty()) {
                throw new DomainException("–ö–Ω–∏–≥–∞ —Å ISBN " + isbn + " –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Google Books");
            }

            return response.getItems().get(0).getVolumeInfo();

        } catch (Exception e) {
            throw new DomainException("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Google Books API: " + e.getMessage());
        }
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class GoogleResponse {
        private List<Item> items;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Item {
        private GoogleBookDto volumeInfo;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class GoogleBookDto {
        private String title;
        private List<String> authors;
        private String description;
        private List<String> categories; // –≠—Ç–æ –±—É–¥—É—Ç –Ω–∞—à–∏ –∂–∞–Ω—Ä—ã
        private List<IndustryIdentifier> industryIdentifiers;
        private ImageLinks imageLinks;
        private Integer pageCount;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class IndustryIdentifier {
        private String type;
        private String identifier;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class ImageLinks {
        private String thumbnail;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\api\OrderController.java
============================================================

package com.bsuir.book_store.orders.api;

import com.bsuir.book_store.orders.api.dto.CreateOrderRequest;
import com.bsuir.book_store.orders.application.OrderService;
import com.bsuir.book_store.orders.domain.Order;
import com.bsuir.book_store.orders.domain.OrderStatus;
import com.bsuir.book_store.shared.security.annotations.IsManager;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/api/orders")
@RequiredArgsConstructor
@Tag(name = "Orders", description = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏")
public class OrderController {

    private final OrderService orderService;

    @Operation(summary = "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", description = "–°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ –∫–Ω–∏–≥ –∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç–∞–≤–∫–µ")
    @PostMapping
    public ResponseEntity<UUID> createOrder(
            @RequestBody CreateOrderRequest request,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        return ResponseEntity.ok(orderService.createOrder(request, userDetails.getUsername()));
    }

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å –º–æ–∏ –∑–∞–∫–∞–∑—ã", description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    @GetMapping("/my")
    public ResponseEntity<List<Order>> getMyOrders(
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        return ResponseEntity.ok(orderService.getMyOrders(userDetails.getUsername()));
    }

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã (–ú–µ–Ω–µ–¥–∂–µ—Ä)", description = "–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ä–æ–ª—å—é MANAGER")
    @GetMapping
    @IsManager
    public ResponseEntity<List<Order>> getAllOrders() {
        return ResponseEntity.ok(orderService.getAllOrders());
    }

    @Operation(summary = "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞", description = "–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π")
    @PatchMapping("/{id}/status")
    @IsManager
    public ResponseEntity<Void> updateStatus(
            @PathVariable UUID id,
            @RequestParam OrderStatus status
    ) {
        orderService.changeStatus(id, status);
        return ResponseEntity.ok().build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\api\dto\CreateOrderRequest.java
============================================================

package com.bsuir.book_store.orders.api.dto;

import lombok.Data;
import java.util.List;
import java.util.UUID;

@Data
public class CreateOrderRequest {
    private List<ItemDto> items;
    private DeliveryDto deliveryDetails;

    @Data
    public static class ItemDto {
        private UUID bookId;
        private int quantity;
    }

    @Data
    public static class DeliveryDto {
        private String customerName;
        private String phone;
        private String address;
        private String timeSlot;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\application\OrderService.java
============================================================

package com.bsuir.book_store.orders.application;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.orders.api.dto.CreateOrderRequest;
import com.bsuir.book_store.orders.domain.DeliveryDetails;
import com.bsuir.book_store.orders.domain.Order;
import com.bsuir.book_store.orders.domain.OrderStatus;
import com.bsuir.book_store.orders.infrastructure.OrderRepository;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.sql.Date;
import java.time.LocalDate;
import java.util.List;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;
    private final BookRepository bookRepository;
    private final UserRepository userRepository;

    @Transactional
    public UUID createOrder(CreateOrderRequest request, String username) {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new DomainException("User not found"));

        Order order = Order.create(user);

        for (var itemRequest : request.getItems()) {
            Book book = bookRepository.findById(itemRequest.getBookId())
                    .orElseThrow(() -> new DomainException("Book not found: " + itemRequest.getBookId()));

            book.reserveStock(itemRequest.getQuantity());

            order.addItem(book, itemRequest.getQuantity());

            bookRepository.save(book);
        }

        DeliveryDetails delivery = DeliveryDetails.builder()
                .customerName(request.getDeliveryDetails().getCustomerName())
                .contactPhone(request.getDeliveryDetails().getPhone())
                .addressText(request.getDeliveryDetails().getAddress())
                .deliveryTimeSlot(request.getDeliveryDetails().getTimeSlot())
                .deliveryDate(Date.valueOf(LocalDate.now().plusDays(1))) // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–∞—Ç—ã
                .build();

        order.attachDeliveryDetails(delivery);

        return orderRepository.save(order).getId();
    }

    @Transactional
    public void changeStatus(UUID orderId, OrderStatus newStatus) {
        Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new DomainException("Order not found"));

        order.updateStatus(newStatus);

        orderRepository.save(order);
    }

    @Transactional(readOnly = true)
    public List<Order> getAllOrders() {
        return orderRepository.findAllByOrderByCreatedAtDesc();
    }

    @Transactional(readOnly = true)
    public List<Order> getMyOrders(String username) {
        return orderRepository.findByUserUsernameOrderByCreatedAtDesc(username);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\domain\DeliveryDetails.java
============================================================

package com.bsuir.book_store.orders.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.sql.Date;
import java.util.UUID;

@Entity
@Table(name = "delivery_details")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class DeliveryDetails {
    @Id
    @Column(name = "order_id")
    private UUID orderId;

    @JsonIgnore
    @OneToOne
    @MapsId
    @JoinColumn(name = "order_id")
    private Order order;

    @Column(name = "customer_name", nullable = false)
    private String customerName;

    @Column(name = "contact_phone", nullable = false)
    private String contactPhone;

    @Column(name = "address_text", columnDefinition = "TEXT", nullable = false)
    private String addressText;

    @Column(name = "delivery_time_slot")
    private String deliveryTimeSlot;

    @Column(name = "delivery_date")
    private Date deliveryDate;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\domain\Order.java
============================================================

package com.bsuir.book_store.orders.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.math.BigDecimal;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@Entity
@Table(name = "orders")
@Getter
@NoArgsConstructor
public class Order {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(name = "order_number", unique = true, nullable = false)
    private String orderNumber;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private OrderStatus status;

    @Column(name = "total_cost", nullable = false)
    private BigDecimal totalCost;

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<OrderItem> orderItems = new ArrayList<>();

    @OneToOne(mappedBy = "order", cascade = CascadeType.ALL, orphanRemoval = true)
    private DeliveryDetails deliveryDetails;

    @Column(name = "order_date")
    private Timestamp orderDate;

    @CreationTimestamp
    private Timestamp createdAt;

    @UpdateTimestamp
    private Timestamp updatedAt;

    public static Order create(User user) {
        Order order = new Order();
        order.user = user;
        order.status = OrderStatus.NEW;
        order.orderNumber = "ORD-" + UUID.randomUUID().toString().substring(0, 8).toUpperCase();
        order.totalCost = BigDecimal.ZERO;
        order.orderItems = new ArrayList<>();
        order.orderDate = Timestamp.valueOf(LocalDateTime.now());
        return order;
    }

    public void addItem(Book book, int quantity) {
        if (quantity <= 0) {
            throw new DomainException("Quantity must be greater than zero");
        }

        OrderItem item = OrderItem.builder()
                .order(this)
                .book(book)
                .bookTitle(book.getTitle())
                .isbn(book.getIsbn())
                .quantity(quantity)
                .pricePerItem(book.getCost())
                .build();

        this.orderItems.add(item);
        recalculateTotal();
    }

    public void attachDeliveryDetails(DeliveryDetails details) {
        if (details == null) throw new DomainException("Delivery details cannot be empty");
        this.deliveryDetails = details;
        details.setOrder(this);
    }

    public void updateStatus(OrderStatus newStatus) {
        if (this.status == OrderStatus.DELIVERED && newStatus == OrderStatus.CANCELLED) {
            throw new DomainException("Cannot cancel an already delivered order");
        }
        if (this.status == OrderStatus.CANCELLED) {
            throw new DomainException("Cannot change status of a cancelled order");
        }
        this.status = newStatus;
    }

    private void recalculateTotal() {
        this.totalCost = orderItems.stream()
                .map(OrderItem::getTotalPrice)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\domain\OrderItem.java
============================================================

package com.bsuir.book_store.orders.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;
import java.util.UUID;

@Entity
@Table(name = "order_items")
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrderItem {
    @Id
    private UUID id;

    @JsonIgnore
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id")
    private Order order;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "book_id")
    private Book book;

    @Column(name = "book_title")
    private String bookTitle;

    private String isbn;

    private Integer quantity;

    @Column(name = "price_per_item")
    private BigDecimal pricePerItem;

    public BigDecimal getTotalPrice() {
        return pricePerItem.multiply(BigDecimal.valueOf(quantity));
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\domain\OrderStatus.java
============================================================

package com.bsuir.book_store.orders.domain;

public enum OrderStatus {
    NEW, PROCESSING, SHIPPED, DELIVERED, CANCELLED
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\infrastructure\OrderRepository.java
============================================================

package com.bsuir.book_store.orders.infrastructure;

import com.bsuir.book_store.orders.domain.Order;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;
import java.util.UUID;

public interface OrderRepository extends JpaRepository<Order, UUID> {
    List<Order> findByUserUsernameOrderByCreatedAtDesc(String username);
    List<Order> findAllByOrderByCreatedAtDesc();
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\api\ReviewController.java
============================================================

package com.bsuir.book_store.reviews.api;

import com.bsuir.book_store.reviews.api.dto.CreateReviewRequest;
import com.bsuir.book_store.reviews.application.ReviewService;
import com.bsuir.book_store.reviews.domain.Review;
import com.bsuir.book_store.shared.security.annotations.IsManager;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/api/reviews")
@RequiredArgsConstructor
@Tag(name = "Reviews", description = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏ –∏ —Ä–µ–π—Ç–∏–Ω–≥–∞–º–∏")
public class ReviewController {

    private final ReviewService reviewService;

    @Operation(
            summary = "–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤",
            description = "–î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–∑—ã–≤ –∫ –∫–Ω–∏–≥–µ –æ—Ç –∏–º–µ–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è."
    )
    @PostMapping
    public ResponseEntity<UUID> addReview(
            @RequestBody CreateReviewRequest request,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        return ResponseEntity.ok(reviewService.addReview(request, userDetails.getUsername()));
    }

    @Operation(
            summary = "–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–∑—ã–≤—ã –∫–Ω–∏–≥–∏",
            description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–Ω–∏–≥–∏, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ."
    )
    @GetMapping("/book/{bookId}")
    public ResponseEntity<List<Review>> getBookReviews(@PathVariable UUID bookId) {
        return ResponseEntity.ok(reviewService.getReviewsForBook(bookId));
    }

    @Operation(
            summary = "–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤ (–ú–æ–¥–µ—Ä–∞—Ü–∏—è)",
            description = "–£–¥–∞–ª—è–µ—Ç –æ—Ç–∑—ã–≤ –ø–æ ID. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ MANAGER."
    )
    @DeleteMapping("/{id}")
    @IsManager
    public ResponseEntity<Void> deleteReview(@PathVariable UUID id) {
        reviewService.deleteReview(id);
        return ResponseEntity.noContent().build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\api\dto\CreateReviewRequest.java
============================================================

package com.bsuir.book_store.reviews.api.dto;

import lombok.Data;
import java.util.UUID;

@Data
public class CreateReviewRequest {
    private UUID bookId;
    private Integer rating;
    private String text;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\application\ReviewService.java
============================================================

package com.bsuir.book_store.reviews.application;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.reviews.api.dto.CreateReviewRequest;
import com.bsuir.book_store.reviews.domain.Review;
import com.bsuir.book_store.reviews.infrastructure.ReviewRepository;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class ReviewService {

    private final ReviewRepository reviewRepository;
    private final BookRepository bookRepository;
    private final UserRepository userRepository;

    @Transactional
    public UUID addReview(CreateReviewRequest request, String username) {
        if (reviewRepository.existsByBookIdAndUserUsername(request.getBookId(), username)) {
            throw new DomainException("–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç—É –∫–Ω–∏–≥—É");
        }

        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new DomainException("User not found"));

        Book book = bookRepository.findById(request.getBookId())
                .orElseThrow(() -> new DomainException("Book not found"));

        Review review = Review.leave(
                user,
                book,
                request.getRating(),
                request.getText()
        );

        return reviewRepository.save(review).getId();
    }

    @Transactional
    public void deleteReview(UUID reviewId) {
        if (!reviewRepository.existsById(reviewId)) {
            throw new DomainException("Review not found");
        }
        reviewRepository.deleteById(reviewId);
    }

    @Transactional(readOnly = true)
    public List<Review> getReviewsForBook(UUID bookId) {
        return reviewRepository.findAllByBookIdOrderByCreatedAtDesc(bookId);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\domain\Review.java
============================================================

package com.bsuir.book_store.reviews.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.sql.Timestamp;
import java.util.UUID;

@Entity
@Table(name = "reviews")
@Getter
@NoArgsConstructor
public class Review {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "book_id", nullable = false)
    private Book book;

    @Column(nullable = false)
    private Integer rating; // 1-5

    @Column(columnDefinition = "TEXT", nullable = false)
    private String text;

    @CreationTimestamp
    @Column(name = "created_at", updatable = false)
    private Timestamp createdAt;

    @UpdateTimestamp
    @Column(name = "updated_at")
    private Timestamp updatedAt;

    public static Review leave(User user, Book book, int rating, String text) {
        validateRating(rating);
        validateText(text);

        Review review = new Review();
        review.id = UUID.randomUUID();
        review.user = user;
        review.book = book;
        review.rating = rating;
        review.text = text;

        return review;
    }

    public void updateContent(int newRating, String newText) {
        validateRating(newRating);
        validateText(newText);

        this.rating = newRating;
        this.text = newText;
    }

    private static void validateRating(int rating) {
        if (rating < 1 || rating > 5) {
            throw new DomainException("–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5");
        }
    }

    private static void validateText(String text) {
        if (text == null || text.isBlank()) {
            throw new DomainException("–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
        }
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\infrastructure\ReviewRepository.java
============================================================

package com.bsuir.book_store.reviews.infrastructure;

import com.bsuir.book_store.reviews.domain.Review;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;
import java.util.UUID;

public interface ReviewRepository extends JpaRepository<Review, UUID> {
    List<Review> findAllByBookIdOrderByCreatedAtDesc(UUID bookId);
    boolean existsByBookIdAndUserUsername(UUID bookId, String username);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\config\ApplicationConfig.java
============================================================

package com.bsuir.book_store.shared.config;

import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
@RequiredArgsConstructor
public class ApplicationConfig {
    private final UserRepository userRepository;

    @Bean
    public UserDetailsService userDetailsService() {
        return username -> userRepository.findByUsername(username)
                .orElseThrow(() -> new UsernameNotFoundException("User not found with username: " + username));
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\config\OpenApiConfig.java
============================================================

package com.bsuir.book_store.shared.config;

import io.swagger.v3.oas.annotations.OpenAPIDefinition;
import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;
import io.swagger.v3.oas.annotations.info.Contact;
import io.swagger.v3.oas.annotations.info.Info;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.security.SecurityScheme;
import org.springframework.context.annotation.Configuration;

@Configuration
@OpenAPIDefinition(
        info = @Info(
                title = "Book Platform API",
                version = "1.0.0",
                description = "API –¥–ª—è –∫–Ω–∏–∂–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞: –∫–∞—Ç–∞–ª–æ–≥, –∫–æ—Ä–∑–∏–Ω–∞, –∑–∞–∫–∞–∑—ã, AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç",
                contact = @Contact(
                        name = "BSUIR Student",
                        email = "student@bsuir.by"
                )
        ),
        security = @SecurityRequirement(name = "JWT")
)
@SecurityScheme(
        name = "JWT",
        type = SecuritySchemeType.HTTP,
        bearerFormat = "JWT",
        scheme = "bearer",
        description = "–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à —Ç–æ–∫–µ–Ω"
)
public class OpenApiConfig {
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\config\SecurityConfig.java
============================================================

package com.bsuir.book_store.shared.config;

import com.bsuir.book_store.shared.security.JwtAuthenticationFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
@EnableMethodSecurity
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtAuthFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.csrf(AbstractHttpConfigurer::disable)
                .authorizeHttpRequests(req -> req
                        .requestMatchers("/api/auth/**").permitAll()
                        .requestMatchers(HttpMethod.GET, "/api/catalog/search").permitAll() // 2. –ü—É–±–ª–∏—á–Ω—ã–µ (—á–∞—Å—Ç–∏—á–Ω–æ)
                        .requestMatchers(
                                "/v3/api-docs/**",
                                "/swagger-ui/**",
                                "/swagger-ui.html"
                        ).permitAll()
                        .anyRequest().authenticated()
                )
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\exception\DomainException.java
============================================================

package com.bsuir.book_store.shared.exception;

import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ResponseStatus;

@ResponseStatus(HttpStatus.BAD_REQUEST)
public class DomainException extends RuntimeException {

    public DomainException(String message) {
        super(message);
    }

    public DomainException(String message, Throwable cause) {
        super(message, cause);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\exception\GlobalExceptionHandler.java
============================================================

package com.bsuir.book_store.shared.exception;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.ConstraintViolationException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authorization.AuthorizationDeniedException;
import org.springframework.web.HttpRequestMethodNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.servlet.resource.NoResourceFoundException;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.stream.Collectors;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(BadCredentialsException.class)
    public ResponseEntity<Object> handleBadCredentials(BadCredentialsException ex, HttpServletRequest request) {
        return buildErrorResponse("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å", HttpStatus.UNAUTHORIZED, request);
    }

    @ExceptionHandler(DomainException.class)
    public ResponseEntity<Object> handleDomainException(DomainException ex, HttpServletRequest request) {
        return buildErrorResponse(ex.getMessage(), HttpStatus.BAD_REQUEST, request);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<Object> handleValidationExceptions(MethodArgumentNotValidException ex, HttpServletRequest request) {
        Map<String, String> errors = ex.getBindingResult().getFieldErrors().stream()
                .collect(Collectors.toMap(
                        error -> error.getField(),
                        error -> error.getDefaultMessage() != null ? error.getDefaultMessage() : "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏",
                        (existing, replacement) -> existing // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –Ω–∞ –æ–¥–Ω–æ–º –ø–æ–ª–µ, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é
                ));

        return buildErrorResponse("–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö", HttpStatus.BAD_REQUEST, request, errors);
    }

    @ExceptionHandler(HttpMessageNotReadableException.class)
    public ResponseEntity<Object> handleJsonErrors(HttpMessageNotReadableException ex, HttpServletRequest request) {
        return buildErrorResponse("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON –∏–ª–∏ –æ—à–∏–±–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏", HttpStatus.BAD_REQUEST, request);
    }

    @ExceptionHandler(MethodArgumentTypeMismatchException.class)
    public ResponseEntity<Object> handleTypeMismatch(MethodArgumentTypeMismatchException ex, HttpServletRequest request) {
        String message = String.format("–ü–∞—Ä–∞–º–µ—Ç—Ä '%s' –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –û–∂–∏–¥–∞–ª—Å—è —Ç–∏–ø: %s",
                ex.getName(), ex.getRequiredType() != null ? ex.getRequiredType().getSimpleName() : "unknown");
        return buildErrorResponse(message, HttpStatus.BAD_REQUEST, request);
    }

    @ExceptionHandler(MissingServletRequestParameterException.class)
    public ResponseEntity<Object> handleMissingParams(MissingServletRequestParameterException ex, HttpServletRequest request) {
        return buildErrorResponse("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞: " + ex.getParameterName(), HttpStatus.BAD_REQUEST, request);
    }

    @ExceptionHandler({jakarta.persistence.EntityNotFoundException.class})
    public ResponseEntity<Object> handleNotFoundException(Exception ex, HttpServletRequest request) {
        return buildErrorResponse(ex.getMessage(), HttpStatus.NOT_FOUND, request);
    }

    @ExceptionHandler(NoResourceFoundException.class)
    public ResponseEntity<Object> handleNoResourceFound(NoResourceFoundException ex, HttpServletRequest request) {
        return buildErrorResponse("–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω: " + ex.getResourcePath(), HttpStatus.NOT_FOUND, request);
    }

    @ExceptionHandler({AccessDeniedException.class, AuthorizationDeniedException.class})
    public ResponseEntity<Object> handleAccessDeniedException(Exception ex, HttpServletRequest request) {
        return buildErrorResponse("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω: —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏", HttpStatus.FORBIDDEN, request);
    }

    @ExceptionHandler(DataIntegrityViolationException.class)
    public ResponseEntity<Object> handleDataIntegrityViolation(DataIntegrityViolationException ex, HttpServletRequest request) {
        return buildErrorResponse("–ù–∞—Ä—É—à–µ–Ω–∏–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (–≤–æ–∑–º–æ–∂–Ω–æ, –∑–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)", HttpStatus.CONFLICT, request);
    }

    @ExceptionHandler(HttpRequestMethodNotSupportedException.class)
    public ResponseEntity<Object> handleMethodNotSupported(HttpRequestMethodNotSupportedException ex, HttpServletRequest request) {
        return buildErrorResponse("–ú–µ—Ç–æ–¥ " + ex.getMethod() + " –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è —ç—Ç–æ–≥–æ URL", HttpStatus.METHOD_NOT_ALLOWED, request);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<Object> handleGlobalException(Exception ex, HttpServletRequest request) {
        log.error("Unhandled exception occurred at {}: ", request.getRequestURI(), ex);
        return buildErrorResponse("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.", HttpStatus.INTERNAL_SERVER_ERROR, request);
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞ ---

    private ResponseEntity<Object> buildErrorResponse(String message, HttpStatus status, HttpServletRequest request) {
        return buildErrorResponse(message, status, request, null);
    }

    private ResponseEntity<Object> buildErrorResponse(String message, HttpStatus status, HttpServletRequest request, Map<String, String> validationErrors) {
        Map<String, Object> body = new HashMap<>();
        body.put("timestamp", LocalDateTime.now());
        body.put("status", status.value());
        body.put("error", status.getReasonPhrase());
        body.put("message", message);
        body.put("path", request.getRequestURI());

        if (validationErrors != null) {
            body.put("validationErrors", validationErrors);
        }

        return new ResponseEntity<>(body, status);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\security\JwtAuthenticationFilter.java
============================================================

package com.bsuir.book_store.shared.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.lang.NonNull;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtService jwtService;
    private final UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(
            @NonNull HttpServletRequest request,
            @NonNull HttpServletResponse response,
            @NonNull FilterChain filterChain
    ) throws ServletException, IOException {

        final String authHeader = request.getHeader("Authorization");

        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        final String jwt = authHeader.substring(7);
        final String username = jwtService.extractUsername(jwt);

        if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = this.userDetailsService.loadUserByUsername(username);

            if (jwtService.isTokenValid(jwt, userDetails)) {
                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                        userDetails,
                        null,
                        userDetails.getAuthorities()
                );
                authToken.setDetails(
                        new WebAuthenticationDetailsSource().buildDetails(request)
                );
                SecurityContextHolder.getContext().setAuthentication(authToken);
            }
        }
        filterChain.doFilter(request, response);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\security\JwtService.java
============================================================

package com.bsuir.book_store.shared.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

@Service
public class JwtService {

    @Value("${application.security.jwt.secret-key}")
    private String secretKey;

    @Value("${application.security.jwt.expiration}")
    private long jwtExpiration;

    public String extractUsername(String token) {
        return extractClaim(token, Claims::getSubject);
    }

    public <T> T extractClaim(String token, Function<Claims, T> claimsResolver) {
        final Claims claims = extractAllClaims(token);
        return claimsResolver.apply(claims);
    }

    public String generateToken(UserDetails userDetails) {
        return generateToken(new HashMap<>(), userDetails);
    }

    public String generateToken(Map<String, Object> extraClaims, UserDetails userDetails) {
        return Jwts
                .builder()
                .setClaims(extraClaims)
                .setSubject(userDetails.getUsername())
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + jwtExpiration))
                .signWith(getSignInKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    public boolean isTokenValid(String token, UserDetails userDetails) {
        final String username = extractUsername(token);
        return (username.equals(userDetails.getUsername())) && !isTokenExpired(token);
    }

    private boolean isTokenExpired(String token) {
        return extractExpiration(token).before(new Date());
    }

    private Date extractExpiration(String token) {
        return extractClaim(token, Claims::getExpiration);
    }

    private Claims extractAllClaims(String token) {
        return Jwts
                .parserBuilder()
                .setSigningKey(getSignInKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    private Key getSignInKey() {
        byte[] keyBytes = Decoders.BASE64.decode(secretKey);
        return Keys.hmacShaKeyFor(keyBytes);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\security\annotations\IsManager.java
============================================================

package com.bsuir.book_store.shared.security.annotations;

import org.springframework.security.access.prepost.PreAuthorize;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("hasAuthority('MANAGER')")
public @interface IsManager {
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\startup\DataInitializer.java
============================================================

package com.bsuir.book_store.shared.startup;

import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.CommandLineRunner;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
@Slf4j
public class DataInitializer implements CommandLineRunner {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    @Value("${manager.password}")
    private String managerPassword;

    @Override
    public void run(String... args) throws Exception {
        if (userRepository.findByRole(Role.MANAGER).isEmpty()) {
            log.info("No managers found. Creating a default manager account...");

            User manager = User.register(
                    "manager",
                    "manager@bookstore.com",
                    passwordEncoder.encode(managerPassword),
                    Role.MANAGER,
                    "System",
                    "Manager",
                    null
            );

            userRepository.save(manager);
            log.info("Default manager account created with username 'manager'");
        }
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\AuthenticationController.java
============================================================

package com.bsuir.book_store.users.api;

import com.bsuir.book_store.users.api.dto.AuthenticationRequest;
import com.bsuir.book_store.users.api.dto.AuthenticationResponse;
import com.bsuir.book_store.users.api.dto.RegisterRequest;
import com.bsuir.book_store.users.application.AuthenticationService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirements;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
@Tag(name = "Authentication", description = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
@SecurityRequirements()
public class AuthenticationController {

    private final AuthenticationService authenticationService;

    @Operation(summary = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", description = "–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞. –ü–∞—Ä–æ–ª—å —à–∏—Ñ—Ä—É–µ—Ç—Å—è. Email –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å.")
    @PostMapping("/register")
    public ResponseEntity<AuthenticationResponse> register(
            @RequestBody @Valid RegisterRequest request
    ) {
        return ResponseEntity.ok(authenticationService.register(request));
    }

    @Operation(summary = "–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É", description = "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∏ –≤—ã–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω.")
    @PostMapping("/authenticate")
    public ResponseEntity<AuthenticationResponse> authenticate(
            @RequestBody AuthenticationRequest request
    ) {
        return ResponseEntity.ok(authenticationService.authenticate(request));
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\UserController.java
============================================================

package com.bsuir.book_store.users.api;

import com.bsuir.book_store.users.api.dto.AddAddressRequest;
import com.bsuir.book_store.users.api.dto.UpdateProfileRequest;
import com.bsuir.book_store.users.api.dto.UserProfileResponse;
import com.bsuir.book_store.users.application.UserService;
import com.bsuir.book_store.users.domain.User;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/users")
@RequiredArgsConstructor
@Tag(name = "User Profile", description = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
public class UserController {

    private final UserService userService;

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å")
    @GetMapping("/me")
    public ResponseEntity<UserProfileResponse> getMyProfile(@AuthenticationPrincipal UserDetails userDetails) {
        return ResponseEntity.ok(userService.getProfile(userDetails.getUsername()));
    }

    @Operation(summary = "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å", description = "–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è, —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω")
    @PatchMapping("/me")
    public ResponseEntity<Void> updateProfile(
            @RequestBody UpdateProfileRequest request,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        userService.updateProfile(userDetails.getUsername(), request);
        return ResponseEntity.ok().build();
    }

    @Operation(summary = "–î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å", description = "–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏")
    @PostMapping("/me/addresses")
    public ResponseEntity<Void> addAddress(
            @RequestBody AddAddressRequest request,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        userService.addAddress(userDetails.getUsername(), request);
        return ResponseEntity.ok().build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\AddAddressRequest.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.Data;

@Data
public class AddAddressRequest {
    private String addressName;
    private String addressText;
    private Boolean isDefault;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\AddressDto.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.Builder;
import lombok.Data;

import java.util.UUID;

@Data
@Builder
public class AddressDto {
    private UUID id;
    private String addressName;
    private String addressText;
    private Boolean isDefault;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\AuthenticationRequest.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class AuthenticationRequest {
    private String username;
    private String password;
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\AuthenticationResponse.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class AuthenticationResponse {
    private String token;
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\RegisterRequest.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class RegisterRequest {
    private String username;
    private String email;
    private String password;

    private String firstName;
    private String lastName;
    private String phone;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\UpdateProfileRequest.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.Data;

@Data
public class UpdateProfileRequest {
    private String firstName;
    private String lastName;
    private String phone;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\UserProfileResponse.java
============================================================

package com.bsuir.book_store.users.api.dto;

import com.bsuir.book_store.users.domain.enums.Role;
import lombok.Builder;
import lombok.Data;

import java.util.List;
import java.util.UUID;

@Data
@Builder
public class UserProfileResponse {
    private UUID id;
    private String username;
    private String email;
    private String contactPhone;
    private String firstName;
    private String lastName;
    private Role role;
    private List<AddressDto> addresses;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\application\AuthenticationService.java
============================================================

package com.bsuir.book_store.users.application;

import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.shared.security.JwtService;
import com.bsuir.book_store.users.api.dto.AuthenticationRequest;
import com.bsuir.book_store.users.api.dto.AuthenticationResponse;
import com.bsuir.book_store.users.api.dto.RegisterRequest;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
public class AuthenticationService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final JwtService jwtService;
    private final AuthenticationManager authenticationManager;

    @Transactional
    public AuthenticationResponse register(RegisterRequest request) {
        if (userRepository.findByUsername(request.getUsername()).isPresent()) {
            throw new DomainException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        if (userRepository.findByEmail(request.getEmail()).isPresent()) {
            throw new DomainException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }

        User.validateRawPassword(request.getPassword());

        User user = User.register(
                request.getUsername(),
                request.getEmail(),
                passwordEncoder.encode(request.getPassword()),
                Role.CLIENT,
                request.getFirstName(),
                request.getLastName(),
                request.getPhone()
        );

        userRepository.save(user);

        var jwtToken = jwtService.generateToken(user);
        return AuthenticationResponse.builder()
                .token(jwtToken)
                .build();
    }

    public AuthenticationResponse authenticate(AuthenticationRequest request) {
        authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(request.getUsername(), request.getPassword())
        );
        var user = userRepository.findByUsername(request.getUsername())
                .orElseThrow(() -> new DomainException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
        return AuthenticationResponse.builder().token(jwtService.generateToken(user)).build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\application\UserService.java
============================================================

package com.bsuir.book_store.users.application;

import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.api.dto.AddAddressRequest;
import com.bsuir.book_store.users.api.dto.AddressDto;
import com.bsuir.book_store.users.api.dto.UpdateProfileRequest;
import com.bsuir.book_store.users.api.dto.UserProfileResponse;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.domain.UserAddress;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
public class UserService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    @Transactional
    public void updateProfile(String username, UpdateProfileRequest request) {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new DomainException("User not found"));

        user.updateProfile(request.getFirstName(), request.getLastName(), request.getPhone());

        userRepository.save(user);
    }

    @Transactional
    public void addAddress(String username, AddAddressRequest request) {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new DomainException("User not found"));

        UserAddress address = UserAddress.builder()
                .addressName(request.getAddressName())
                .addressText(request.getAddressText())
                .isDefault(request.getIsDefault())
                .build();

        user.addAddress(address);

        userRepository.save(user);
    }

    @Transactional
    public void changePassword(String username, String newPassword) {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new DomainException("User not found"));

        User.validateRawPassword(newPassword);

        user.changePassword(passwordEncoder.encode(newPassword));
        userRepository.save(user);
    }

    @Transactional(readOnly = true)
    public UserProfileResponse getProfile(String username) {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new DomainException("User not found"));

        List<AddressDto> addressDtos = user.getAddresses().stream()
                .map(addr -> AddressDto.builder()
                        .id(addr.getId())
                        .addressName(addr.getAddressName())
                        .addressText(addr.getAddressText())
                        .isDefault(addr.getIsDefault())
                        .build())
                .toList();

        return UserProfileResponse.builder()
                .id(user.getId())
                .username(user.getUsername())
                .email(user.getEmail())
                .contactPhone(user.getContactPhone())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .role(user.getRole())
                .addresses(addressDtos)
                .build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\domain\User.java
============================================================

package com.bsuir.book_store.users.domain;

import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.enums.Role;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.UUID;
import java.util.regex.Pattern;

@Entity
@Table(name = "users")
@Getter
@NoArgsConstructor
public class User implements UserDetails {

    // Email: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
    private static final Pattern EMAIL_PATTERN = Pattern.compile("^[A-Za-z0-9+_.-]+@(.+)$");

    // –¢–µ–ª–µ—Ñ–æ–Ω: –æ—Ç 10 –¥–æ 15 —Ü–∏—Ñ—Ä, –º–æ–∂–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å +
    private static final Pattern PHONE_PATTERN = Pattern.compile("^\\+?[0-9]{10,15}$");

    // Username: 4-20 —Å–∏–º–≤–æ–ª–æ–≤, –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
    private static final Pattern USERNAME_PATTERN = Pattern.compile("^[a-zA-Z0-9._]{4,20}$");

    // –ü–∞—Ä–æ–ª—å: –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –º–∏–Ω–∏–º—É–º 1 –±—É–∫–≤–∞ –∏ 1 —Ü–∏—Ñ—Ä–∞
    private static final Pattern PASSWORD_PATTERN = Pattern.compile("^(?=.*[0-9])(?=.*[a-zA-Z]).{8,}$");

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(unique = true, nullable = false)
    private String username;

    @Column(nullable = false)
    private String password; // –•–µ—à –ø–∞—Ä–æ–ª—è

    @Column(unique = true, nullable = false)
    private String email;

    @Column(name = "contact_phone")
    private String contactPhone;

    @Column(name = "first_name")
    private String firstName;

    @Column(name = "last_name")
    private String lastName;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private Role role;

    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<UserAddress> addresses = new ArrayList<>();

    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private Timestamp createdAt;

    @UpdateTimestamp
    @Column(nullable = false)
    private Timestamp updatedAt;

    public static User register(String username, String email, String encodedPassword, Role role,
                                String firstName, String lastName, String phone) {
        validateEmail(email);
        validateUsername(username);

        User user = new User();
        user.username = username;
        user.email = email;
        user.password = encodedPassword;
        user.role = role != null ? role : Role.CLIENT;
        user.createdAt = Timestamp.valueOf(LocalDateTime.now());

        user.updateProfile(firstName, lastName, phone);

        return user;
    }

    public void updateProfile(String firstName, String lastName, String contactPhone) {
        if (firstName != null && !firstName.isBlank()) {
            this.firstName = firstName.trim();
        }
        if (lastName != null && !lastName.isBlank()) {
            this.lastName = lastName.trim();
        }
        if (contactPhone != null && !contactPhone.isBlank()) {
            validatePhone(contactPhone);
            this.contactPhone = contactPhone.trim();
        }
    }

    public void addAddress(UserAddress address) {
        if (address == null) throw new DomainException("Address cannot be null");

        if (Boolean.TRUE.equals(address.getIsDefault())) {
            this.addresses.forEach(UserAddress::unsetDefault);
        } else if (this.addresses.isEmpty()) {
            address.makeDefault();
        }

        address.assignToUser(this);
        this.addresses.add(address);
    }

    public void changePassword(String newEncodedPassword) {
        if (newEncodedPassword == null || newEncodedPassword.isBlank()) {
            throw new DomainException("Password hash cannot be empty");
        }
        this.password = newEncodedPassword;
    }

    public static void validateRawPassword(String rawPassword) {
        if (rawPassword == null || !PASSWORD_PATTERN.matcher(rawPassword).matches()) {
            throw new DomainException("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –≤–∫–ª—é—á–∞—è –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã");
        }
    }

    private static void validateEmail(String email) {
        if (email == null || !EMAIL_PATTERN.matcher(email).matches()) {
            throw new DomainException("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email");
        }
    }

    private static void validateUsername(String username) {
        if (username == null || !USERNAME_PATTERN.matcher(username).matches()) {
            throw new DomainException("–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 4 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, '.', '_')");
        }
    }

    private static void validatePhone(String phone) {
        if (!PHONE_PATTERN.matcher(phone).matches()) {
            throw new DomainException("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü—Ä–∏–º–µ—Ä: +375291234567");
        }
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return List.of(new SimpleGrantedAuthority(role.name()));
    }

    @Override
    public boolean isAccountNonExpired() { return true; }

    @Override
    public boolean isAccountNonLocked() { return true; }

    @Override
    public boolean isCredentialsNonExpired() { return true; }

    @Override
    public boolean isEnabled() { return true; }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\domain\UserAddress.java
============================================================

package com.bsuir.book_store.users.domain;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Builder;
import lombok.AllArgsConstructor;

import java.util.UUID;

@Entity
@Table(name = "user_addresses")
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserAddress {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @Column(name = "address_name")
    private String addressName; // "–î–æ–º", "–†–∞–±–æ—Ç–∞"

    @Column(name = "address_text", nullable = false)
    private String addressText;

    @Column(name = "is_default")
    private Boolean isDefault;

    void assignToUser(User user) {
        this.user = user;
    }

    public void makeDefault() {
        this.isDefault = true;
    }

    void unsetDefault() {
        this.isDefault = false;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\domain\enums\Role.java
============================================================

package com.bsuir.book_store.users.domain.enums;

public enum Role {
    CLIENT,
    MANAGER
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\infrastructure\UserRepository.java
============================================================

package com.bsuir.book_store.users.infrastructure;

import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.domain.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Repository
public interface UserRepository extends JpaRepository<User, UUID> {
    Optional<User> findByUsername(String username);
    Optional<User> findByEmail(String email); // –î–æ–±–∞–≤–ª–µ–Ω–æ
    List<User> findByRole(Role role);
}

============================================================
FILE PATH: src\main\resources\application-docker.properties
============================================================

spring.datasource.url=jdbc:mysql://mysql-db:3306/book_store?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.elasticsearch.uris=http://elasticsearch:9201

============================================================
FILE PATH: src\main\resources\application-example.properties
============================================================

# =======================================
# ????? ????????? ??????????
# =======================================
spring.application.name=book-store

# =======================================
# ????????? ??????????? ? ???? ??????
# ???????? 'your_...' ?? ???? ????????? ??????
# =======================================
spring.datasource.url=jdbc:mysql://localhost:3306/your_database_name?useSSL=false
spring.datasource.username=your_database_username
spring.datasource.password=your_database_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# =======================================
# ????????? JPA / HIBERNATE
# =======================================
# ????????? Open Session In View, ??? ???????? ?????? ????????? ??? REST API
spring.jpa.open-in-view=false
# ??? ????????? ?????????? 'update' ????????? Hibernate ????????????? ?????????/????????? ???????
# ????????: ??? ?????????? ??????????? 'validate' ??? 'none'
spring.jpa.hibernate.ddl-auto=update
# ?????????? SQL-??????? ? ??????? (??????? ??? ???????)
spring.jpa.show-sql=true

# =======================================
# ????????? ???????????? (JWT)
# =======================================
# ???????????? ???? ??????????? ????????? ???? (????????, 256-?????? Base64)
application.security.jwt.secret-key=your_secret_jwt_key
# ????? ????? ?????? ? ????????????? (????? - 24 ????)
application.security.jwt.expiration=86400000

# =======================================
# ????????? ?? ?????????
# =======================================
# ?????? ??? ???????? ?????????, ??????? ????????? ??? ?????? ???????
manager.password=your_secure_manager_password

============================================================
FILE PATH: src\main\resources\application.properties
============================================================

spring.application.name=book-store

server.port=8081

spring.datasource.url=jdbc:mysql://localhost:3306/book_store?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.elasticsearch.uris=http://localhost:9201
spring.elasticsearch.connection-timeout=10s
spring.elasticsearch.socket-timeout=10s

spring.jpa.open-in-view=false
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

application.security.jwt.secret-key=cHJldHR5aG9sbG93YWNjb3JkaW5nb3JhbmdlZ2lmdHdpc2VzdHJhbmdlc3RhaXJzdGU=
application.security.jwt.expiration=86400000

manager.password=manager

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\BookStoreApplicationTests.java
============================================================

package com.bsuir.book_store;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class BookStoreApplicationTests {

	@Test
	void contextLoads() {
	}

}


============================================================
FILE PATH: src\test\java\com\bsuir\book_store\analytics\api\AnalyticsControllerTest.java
============================================================

package com.bsuir.book_store.analytics.api;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.orders.domain.Order;
import com.bsuir.book_store.orders.infrastructure.OrderRepository;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import com.bsuir.book_store.shared.security.JwtService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;
import com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository;

import java.math.BigDecimal;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
class AnalyticsControllerTest {

    @Autowired private MockMvc mockMvc;
    @Autowired private UserRepository userRepository;
    @Autowired private OrderRepository orderRepository;
    @Autowired private BookRepository bookRepository;
    @Autowired private JwtService jwtService;
    @Autowired private PasswordEncoder passwordEncoder;

    @MockitoBean
    private BookElasticRepository elasticRepository;

    private String managerToken;
    private String clientToken;

    @BeforeEach
    void setUp() {
        orderRepository.deleteAll();
        userRepository.deleteAll();
        bookRepository.deleteAll();

        User manager = User.register("admin", "admin@test.com", passwordEncoder.encode("p"), Role.MANAGER, null, null, null);
        userRepository.save(manager);
        managerToken = jwtService.generateToken(manager);

        User client = User.register("client", "c@test.com", passwordEncoder.encode("p"), Role.CLIENT, null, null, null);
        userRepository.save(client);
        clientToken = jwtService.generateToken(client);

        Book book = Book.builder().title("Java Book").isbn("1").cost(new BigDecimal("100.00")).stockQuantity(10).build();
        bookRepository.save(book);

        Order order = Order.create(client);
        order.addItem(book, 2);
        orderRepository.save(order);
    }

    @Test
    void managerShouldSeeDashboard() throws Exception {
        mockMvc.perform(get("/api/analytics")
                        .header("Authorization", "Bearer " + managerToken))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.summary.totalOrders").value(1))
                .andExpect(jsonPath("$.summary.totalRevenue").value(200.0))
                .andExpect(jsonPath("$.summary.totalBooksSold").value(2));
    }

    @Test
    void clientShouldNotSeeDashboard() throws Exception {
        mockMvc.perform(get("/api/analytics")
                        .header("Authorization", "Bearer " + clientToken))
                .andExpect(status().isForbidden());
    }
}

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\assistant\api\ChatControllerTest.java
============================================================

package com.bsuir.book_store.assistant.api;

import com.bsuir.book_store.assistant.api.dto.ChatRequest;
import com.bsuir.book_store.assistant.application.BookStoreAssistant;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import com.bsuir.book_store.shared.security.JwtService;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;

import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
class ChatControllerTest {

    @Autowired private MockMvc mockMvc;
    @Autowired private UserRepository userRepository;
    @Autowired private JwtService jwtService;
    @Autowired private ObjectMapper objectMapper;
    @Autowired private PasswordEncoder passwordEncoder;

    @MockitoBean
    private BookStoreAssistant assistant;

    @MockitoBean
    private com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository elasticRepository;

    private String token;

    @BeforeEach
    void setUp() {
        userRepository.deleteAll();
        User user = User.register("user", "u@u.com", passwordEncoder.encode("p"), Role.CLIENT, null, null, null);
        userRepository.save(user);
        token = jwtService.generateToken(user);
    }

    @Test
    void shouldReturnAiResponse() throws Exception {
        when(assistant.chat(eq("user"), anyString())).thenReturn("I am AI");

        ChatRequest request = new ChatRequest();
        request.setMessage("Hello!");

        mockMvc.perform(post("/api/chat")
                        .header("Authorization", "Bearer " + token)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.response").value("I am AI"));
    }

    @Test
    void shouldFailWithoutAuth() throws Exception {
        ChatRequest request = new ChatRequest();
        request.setMessage("Hello!");

        mockMvc.perform(post("/api/chat")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isForbidden());
    }
}

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\orders\api\OrderControllerTest.java
============================================================

package com.bsuir.book_store.orders.api;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.orders.api.dto.CreateOrderRequest;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import com.bsuir.book_store.shared.security.JwtService;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;

import java.math.BigDecimal;
import java.util.List;
import java.util.UUID;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
class OrderControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private BookRepository bookRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private JwtService jwtService;

    @Autowired
    private ObjectMapper objectMapper;

    @MockitoBean
    private com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository elasticRepository;

    private String token;
    private UUID bookId;

    @BeforeEach
    void setUp() {
        userRepository.deleteAll();
        bookRepository.deleteAll();

        User user = User.register("client", "client@test.com", passwordEncoder.encode("pass"), Role.CLIENT, null, null, null);
        userRepository.save(user);
        token = jwtService.generateToken(user);

        Book book = Book.builder()
                .title("Test Book")
                .isbn("1234567890")
                .cost(BigDecimal.TEN)
                .stockQuantity(10)
                .build();
        bookId = bookRepository.save(book).getId();
    }

    @Test
    void shouldCreateOrderSuccessfully() throws Exception {
        CreateOrderRequest request = new CreateOrderRequest();

        CreateOrderRequest.ItemDto item = new CreateOrderRequest.ItemDto();
        item.setBookId(bookId);
        item.setQuantity(1);
        request.setItems(List.of(item));

        CreateOrderRequest.DeliveryDto delivery = new CreateOrderRequest.DeliveryDto();
        delivery.setAddress("Minsk");
        delivery.setPhone("+375000000000");
        delivery.setCustomerName("Ivan");
        request.setDeliveryDetails(delivery);

        mockMvc.perform(post("/api/orders")
                        .header("Authorization", "Bearer " + token)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk());
    }

    @Test
    void shouldFailWhenNotAuthenticated() throws Exception {
        mockMvc.perform(post("/api/orders")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content("{}"))
                .andExpect(status().isForbidden());
    }
}

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\orders\domain\OrderTest.java
============================================================

package com.bsuir.book_store.orders.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import org.junit.jupiter.api.Test;

import java.math.BigDecimal;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.*;

class OrderTest {

    @Test
    void shouldCalculateTotalCostCorrectly() {
        User user = new User();
        Order order = Order.create(user);

        Book book1 = Book.builder().id(UUID.randomUUID()).title("Book 1").cost(new BigDecimal("10.00")).stockQuantity(10).build();
        Book book2 = Book.builder().id(UUID.randomUUID()).title("Book 2").cost(new BigDecimal("20.00")).stockQuantity(5).build();

        order.addItem(book1, 2);
        order.addItem(book2, 1);

        assertEquals(new BigDecimal("40.00"), order.getTotalCost());
    }

    @Test
    void shouldNotAllowStatusChangeFromCancelled() {
        User user = new User();
        Order order = Order.create(user);
        order.updateStatus(OrderStatus.CANCELLED);

        assertThrows(DomainException.class, () -> order.updateStatus(OrderStatus.SHIPPED));
    }
}

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\reviews\api\ReviewControllerTest.java
============================================================

package com.bsuir.book_store.reviews.api;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.reviews.api.dto.CreateReviewRequest;
import com.bsuir.book_store.reviews.infrastructure.ReviewRepository;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import com.bsuir.book_store.shared.security.JwtService;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;

import java.math.BigDecimal;
import java.util.UUID;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
class ReviewControllerTest {

    @Autowired private MockMvc mockMvc;
    @Autowired private ReviewRepository reviewRepository;
    @Autowired private UserRepository userRepository;
    @Autowired private BookRepository bookRepository;
    @Autowired private PasswordEncoder passwordEncoder;
    @Autowired private JwtService jwtService;
    @Autowired private ObjectMapper objectMapper;

    @MockitoBean
    private com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository elasticRepository;

    private String clientToken;
    private String managerToken;
    private UUID bookId;

    @BeforeEach
    void setUp() {
        reviewRepository.deleteAll();
        userRepository.deleteAll();
        bookRepository.deleteAll();

        User client = User.register("client", "c@test.com", passwordEncoder.encode("123"), Role.CLIENT, null, null, null);
        userRepository.save(client);
        clientToken = jwtService.generateToken(client);

        User manager = User.register("manager", "m@test.com", passwordEncoder.encode("123"), Role.MANAGER, null, null, null);
        userRepository.save(manager);
        managerToken = jwtService.generateToken(manager);

        Book book = Book.builder().title("Test Book").isbn("111").cost(BigDecimal.TEN).stockQuantity(10).build();
        bookId = bookRepository.save(book).getId();
    }

    @Test
    void shouldAddReviewSuccessfully() throws Exception {
        CreateReviewRequest request = new CreateReviewRequest();
        request.setBookId(bookId);
        request.setRating(5);
        request.setText("Excellent!");

        mockMvc.perform(post("/api/reviews")
                        .header("Authorization", "Bearer " + clientToken)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk());
    }

    @Test
    void shouldForbidDuplicateReview() throws Exception {
        CreateReviewRequest request = new CreateReviewRequest();
        request.setBookId(bookId);
        request.setRating(5);
        request.setText("First");

        mockMvc.perform(post("/api/reviews")
                        .header("Authorization", "Bearer " + clientToken)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk());

        mockMvc.perform(post("/api/reviews")
                        .header("Authorization", "Bearer " + clientToken)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isBadRequest());
    }

    @Test
    void managerShouldDeleteReview() throws Exception {
        User client = userRepository.findByUsername("client").get();
        Book book = bookRepository.findById(bookId).get();
        var review = com.bsuir.book_store.reviews.domain.Review.leave(client, book, 5, "Text");
        UUID reviewId = reviewRepository.save(review).getId();

        mockMvc.perform(delete("/api/reviews/" + reviewId)
                        .header("Authorization", "Bearer " + managerToken))
                .andExpect(status().isNoContent());
    }

    @Test
    void clientCannotDeleteReview() throws Exception {
        UUID randomId = UUID.randomUUID();
        mockMvc.perform(delete("/api/reviews/" + randomId)
                        .header("Authorization", "Bearer " + clientToken))
                .andExpect(status().isForbidden());
    }
}

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\reviews\domain\ReviewTest.java
============================================================

package com.bsuir.book_store.reviews.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

class ReviewTest {

    @Test
    void shouldCreateValidReview() {
        Review review = Review.leave(new User(), new Book(), 5, "Great book!");

        assertNotNull(review.getId());
        assertEquals(5, review.getRating());
        assertEquals("Great book!", review.getText());
    }

    @Test
    void shouldFailOnInvalidRating() {
        assertThrows(DomainException.class, () ->
                Review.leave(new User(), new Book(), 6, "Wow")
        );

        assertThrows(DomainException.class, () ->
                Review.leave(new User(), new Book(), 0, "Bad")
        );
    }

    @Test
    void shouldFailOnEmptyText() {
        assertThrows(DomainException.class, () ->
                Review.leave(new User(), new Book(), 5, "")
        );
    }
}

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\users\api\AuthenticationControllerTest.java
============================================================

package com.bsuir.book_store.users.api;

import com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository;
import com.bsuir.book_store.users.api.dto.RegisterRequest;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;

import static org.hamcrest.Matchers.hasKey;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
class AuthenticationControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ObjectMapper objectMapper;

    @MockitoBean
    private BookElasticRepository bookElasticRepository;

    @BeforeEach
    void setUp() {
        userRepository.deleteAll();
    }

    @Test
    void shouldRegisterNewUser() throws Exception {
        RegisterRequest request = new RegisterRequest();
        request.setUsername("newuser");
        request.setEmail("new@test.com");
        request.setPassword("StrongPass1");

        mockMvc.perform(post("/api/auth/register")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", hasKey("token")));

        assertTrue(userRepository.findByUsername("newuser").isPresent());
    }

    @Test
    void shouldFailRegistrationWithWeakPassword() throws Exception {
        RegisterRequest request = new RegisterRequest();
        request.setUsername("newuser");
        request.setEmail("new@test.com");
        request.setPassword("123");

        mockMvc.perform(post("/api/auth/register")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isBadRequest()); // –û–∂–∏–¥–∞–µ–º 400
    }
}

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\users\domain\UserTest.java
============================================================

package com.bsuir.book_store.users.domain;

import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.enums.Role;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

class UserTest {

    @Test
    @DisplayName("Should register user with valid data")
    void shouldRegisterUser() {
        User user = User.register(
                "testuser",
                "test@example.com",
                "encrypted_pass",
                Role.CLIENT,
                "John",
                "Doe",
                "+375291112233"
        );

        assertNull(user.getId());
        assertEquals("testuser", user.getUsername());
        assertEquals("John", user.getFirstName());
        assertNotNull(user.getCreatedAt());
    }

    @Test
    @DisplayName("Should throw exception for invalid email")
    void shouldFailOnInvalidEmail() {
        assertThrows(DomainException.class, () -> User.register(
                "testuser",
                "invalid-email", // –û—à–∏–±–∫–∞
                "pass",
                Role.CLIENT,
                null, null, null
        ));
    }

    @Test
    @DisplayName("Should throw exception for short password")
    void shouldFailOnShortPassword() {
        assertThrows(DomainException.class, () -> User.validateRawPassword("123"));
    }

    @Test
    @DisplayName("Should add address and manage default flag")
    void shouldAddAddress() {
        User user = new User();

        user = User.register("user1", "e@e.com", "p", Role.CLIENT, null, null, null);

        UserAddress addr1 = UserAddress.builder().addressName("Home").addressText("Street 1").isDefault(true).build();
        UserAddress addr2 = UserAddress.builder().addressName("Work").addressText("Street 2").isDefault(true).build();

        user.addAddress(addr1);
        assertTrue(addr1.getIsDefault());

        user.addAddress(addr2);

        assertFalse(addr1.getIsDefault());
        assertTrue(addr2.getIsDefault());
        assertEquals(2, user.getAddresses().size());
    }
}

============================================================
FILE PATH: src\test\resources\application-test.properties
============================================================

spring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;MODE=MySQL
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
spring.jpa.hibernate.ddl-auto=create-drop

spring.elasticsearch.uris=http://localhost:9201
spring.data.elasticsearch.repositories.enabled=false
