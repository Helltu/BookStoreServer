
============================================================
FILE PATH: docker-compose.yml
============================================================

services:
    book-store-app:
      build: .
      ports:
        - "8080:8080"
      environment:
        - SPRING_PROFILES_ACTIVE=docker
      depends_on:
        mysql-db:
          condition: service_healthy
        elasticsearch:
          condition: service_started

    mysql-db:
      image: mysql:8.0
      ports:
        - "3306:3306"
      environment:
        - MYSQL_ROOT_PASSWORD=root
        - MYSQL_DATABASE=book_store
      volumes:
        - mysql-data:/var/lib/mysql
      healthcheck:
        test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
        interval: 10s
        timeout: 5s
        retries: 5

    elasticsearch:
      image: elasticsearch:8.11.1
      ports:
        - "9201:9200"
        - "9300:9300"
      environment:
        - discovery.type=single-node
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      volumes:
        - elasticsearch-data:/usr/share/elasticsearch/data

volumes:
  mysql-data:
  elasticsearch-data:

============================================================
FILE PATH: HELP.md
============================================================

# Read Me First
The following was discovered as part of building this project:

* The original package name 'com.bsuir.book-store' is invalid and this project uses 'com.bsuir.book_store' instead.

# Getting Started

### Reference Documentation
For further reference, please consider the following sections:

* [Official Apache Maven documentation](https://maven.apache.org/guides/index.html)
* [Spring Boot Maven Plugin Reference Guide](https://docs.spring.io/spring-boot/3.5.7/maven-plugin)
* [Create an OCI image](https://docs.spring.io/spring-boot/3.5.7/maven-plugin/build-image.html)
* [Spring Security](https://docs.spring.io/spring-boot/3.5.7/reference/web/spring-security.html)
* [Spring Web](https://docs.spring.io/spring-boot/3.5.7/reference/web/servlet.html)
* [Spring Data JPA](https://docs.spring.io/spring-boot/3.5.7/reference/data/sql.html#data.sql.jpa-and-spring-data)

### Guides
The following guides illustrate how to use some features concretely:

* [Securing a Web Application](https://spring.io/guides/gs/securing-web/)
* [Spring Boot and OAuth2](https://spring.io/guides/tutorials/spring-boot-oauth2/)
* [Authenticating a User with LDAP](https://spring.io/guides/gs/authenticating-ldap/)
* [Building a RESTful Web Service](https://spring.io/guides/gs/rest-service/)
* [Serving Web Content with Spring MVC](https://spring.io/guides/gs/serving-web-content/)
* [Building REST services with Spring](https://spring.io/guides/tutorials/rest/)
* [Accessing Data with JPA](https://spring.io/guides/gs/accessing-data-jpa/)
* [Accessing data with MySQL](https://spring.io/guides/gs/accessing-data-mysql/)

### Maven Parent overrides

Due to Maven's design, elements are inherited from the parent POM to the project POM.
While most of the inheritance is fine, it also inherits unwanted elements like `<license>` and `<developers>` from the parent.
To prevent this, the project POM contains empty overrides for these elements.
If you manually switch to a different parent and actually want the inheritance, you need to remove those overrides.



============================================================
FILE PATH: pom.xml
============================================================

<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.5.7</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.bsuir</groupId>
	<artifactId>book-store</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>book-store</name>
	<description>Demo project for Spring Boot</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>21</java.version>
	</properties>
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>com.mysql</groupId>
			<artifactId>mysql-connector-j</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.security</groupId>
			<artifactId>spring-security-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-elasticsearch</artifactId>
		</dependency>
		<dependency>
			<groupId>dev.langchain4j</groupId>
			<artifactId>langchain4j-spring-boot-starter</artifactId>
			<version>0.35.0</version>
		</dependency>
		<dependency>
			<groupId>dev.langchain4j</groupId>
			<artifactId>langchain4j-open-ai</artifactId>
			<version>0.35.0</version>
		</dependency>
		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
			<version>2.8.14</version>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
							<version>1.18.42</version>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>


============================================================
FILE PATH: README.md
============================================================

# BookStoreServer

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\BookStoreApplication.java
============================================================

package com.bsuir.book_store;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class BookStoreApplication {

	public static void main(String[] args) {
		SpringApplication.run(BookStoreApplication.class, args);
	}

}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\analytics\api\AnalyticsController.java
============================================================

package com.bsuir.book_store.analytics.api;

import com.bsuir.book_store.analytics.api.dto.AnalyticsResponse;
import com.bsuir.book_store.analytics.application.AnalyticsService;
import com.bsuir.book_store.shared.security.annotations.IsManager;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/analytics")
@RequiredArgsConstructor
@Tag(name = "Analytics", description = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂")
public class AnalyticsController {

    private final AnalyticsService analyticsService;

    @Operation(
            summary = "–ü–æ–ª—É—á–∏—Ç—å –¥–∞—à–±–æ—Ä–¥",
            description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º, —Ç–æ–ø –∫–Ω–∏–≥ –∏ –≥—Ä–∞—Ñ–∏–∫–∏. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ MANAGER."
    )
    @GetMapping
    @IsManager
    public ResponseEntity<AnalyticsResponse> getDashboard() {
        return ResponseEntity.ok(analyticsService.getDashboardData());
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\analytics\api\dto\AnalyticsResponse.java
============================================================

package com.bsuir.book_store.analytics.api.dto;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
public class AnalyticsResponse {
    private Summary summary;

    private List<DatePoint> salesOverTime;

    private List<CategoryPoint> salesByCategory;

    private List<BookPoint> topSellingBooks;

    @Data
    @Builder
    public static class Summary {
        private long totalOrders;
        private BigDecimal totalRevenue;
        private long totalBooksSold;
        private double averageCheck;
    }

    @Data
    @Builder
    public static class DatePoint {
        private String date;
        private BigDecimal value;
    }

    @Data
    @Builder
    public static class CategoryPoint {
        private String category;
        private long count;
    }

    @Data
    @Builder
    public static class BookPoint {
        private String title;
        private long soldCount;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\analytics\application\AnalyticsService.java
============================================================

package com.bsuir.book_store.analytics.application;

import com.bsuir.book_store.analytics.api.dto.AnalyticsResponse;
import com.bsuir.book_store.orders.domain.Order;
import com.bsuir.book_store.orders.domain.OrderItem;
import com.bsuir.book_store.orders.domain.OrderStatus;
import com.bsuir.book_store.orders.infrastructure.OrderRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class AnalyticsService {

    private final OrderRepository orderRepository;

    @Transactional(readOnly = true)
    public AnalyticsResponse getDashboardData() {
        List<Order> orders = orderRepository.findAll().stream()
                .filter(o -> o.getStatus() != OrderStatus.CANCELLED)
                .toList();

        long totalOrders = orders.size();
        BigDecimal totalRevenue = orders.stream()
                .map(Order::getTotalCost) // –í –≤–∞—à–µ–π —Å—É—â–Ω–æ—Å—Ç–∏ Order –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è totalCost
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        long totalBooksSold = orders.stream()
                .flatMap(o -> o.getOrderItems().stream())
                .mapToLong(OrderItem::getQuantity)
                .sum();

        double averageCheck = totalOrders > 0
                ? totalRevenue.divide(BigDecimal.valueOf(totalOrders), 2, RoundingMode.HALF_UP).doubleValue()
                : 0.0;

        // 3. –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂ –ø–æ –¥–∞—Ç–∞–º (Sales Over Time)
        Map<LocalDate, BigDecimal> revenueByDate = orders.stream()
                .collect(Collectors.groupingBy(
                        order -> order.getCreatedAt().toLocalDateTime().toLocalDate(),
                        Collectors.reducing(BigDecimal.ZERO, Order::getTotalCost, BigDecimal::add)
                ));

        List<AnalyticsResponse.DatePoint> salesOverTime = revenueByDate.entrySet().stream()
                .sorted(Map.Entry.comparingByKey())
                .map(entry -> AnalyticsResponse.DatePoint.builder()
                        .date(entry.getKey().format(DateTimeFormatter.ISO_DATE))
                        .value(entry.getValue())
                        .build())
                .toList();

        List<OrderItem> allItems = orders.stream()
                .flatMap(o -> o.getOrderItems().stream())
                .toList();

        Map<String, Long> categoryStats = allItems.stream()
                .flatMap(item -> item.getBook().getGenres().stream())
                .collect(Collectors.groupingBy(
                        genre -> genre.getName(),
                        Collectors.counting()
                ));

        List<AnalyticsResponse.CategoryPoint> salesByCategory = categoryStats.entrySet().stream()
                .map(entry -> AnalyticsResponse.CategoryPoint.builder()
                        .category(entry.getKey())
                        .count(entry.getValue())
                        .build())
                .toList();

        // 5. –¢–æ–ø –ø—Ä–æ–¥–∞–≤–∞–µ–º—ã—Ö –∫–Ω–∏–≥
        Map<String, Long> bookStats = allItems.stream()
                .collect(Collectors.groupingBy(
                        item -> item.getBookTitle(), // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        Collectors.summingLong(OrderItem::getQuantity)
                ));

        List<AnalyticsResponse.BookPoint> topBooks = bookStats.entrySet().stream()
                .sorted(Map.Entry.<String, Long>comparingByValue().reversed())
                .limit(5) // –¢–æ–ø-5
                .map(entry -> AnalyticsResponse.BookPoint.builder()
                        .title(entry.getKey())
                        .soldCount(entry.getValue())
                        .build())
                .toList();

        return AnalyticsResponse.builder()
                .summary(AnalyticsResponse.Summary.builder()
                        .totalOrders(totalOrders)
                        .totalRevenue(totalRevenue)
                        .totalBooksSold(totalBooksSold)
                        .averageCheck(averageCheck)
                        .build())
                .salesOverTime(salesOverTime)
                .salesByCategory(salesByCategory)
                .topSellingBooks(topBooks)
                .build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\api\ChatController.java
============================================================

package com.bsuir.book_store.assistant.api;

import com.bsuir.book_store.assistant.api.dto.ChatRequest;
import com.bsuir.book_store.assistant.api.dto.ChatResponse;
import com.bsuir.book_store.assistant.application.BookStoreAssistant;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/chat")
@RequiredArgsConstructor
@Tag(name = "AI Assistant", description = "–ß–∞—Ç —Å —É–º–Ω—ã–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º")
public class ChatController {

    private final BookStoreAssistant assistant;

    @Operation(summary = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", description = "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ LLM (OpenAI)")
    @PostMapping
    public ResponseEntity<ChatResponse> chat(
            @RequestBody ChatRequest request,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        String aiResponse = assistant.chat(userDetails.getUsername(), request.getMessage());

        return ResponseEntity.ok(new ChatResponse(aiResponse));
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\api\dto\ChatRequest.java
============================================================

package com.bsuir.book_store.assistant.api.dto;
import lombok.Data;

@Data
public class ChatRequest {
    private String message;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\api\dto\ChatResponse.java
============================================================

package com.bsuir.book_store.assistant.api.dto;
import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class ChatResponse {
    private String response;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\application\BookStoreAssistant.java
============================================================

package com.bsuir.book_store.assistant.application;

import dev.langchain4j.service.SystemMessage;
import dev.langchain4j.service.UserMessage;
import dev.langchain4j.service.V;

public interface BookStoreAssistant {

    @SystemMessage("""
            ### –†–û–õ–¨ –ò –¶–ï–õ–¨
            –¢—ã ‚Äî **Senior Technical Consultant** –≤ –∫–Ω–∏–∂–Ω–æ–º –º–∞–≥–∞–∑–∏–Ω–µ "BookStore".
            –¢–≤–æ—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ (–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, DevOps, Data Science, –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç –≤ IT).
            –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–π—Ç–∏ –∫–Ω–∏–≥—É, –∞ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–¥–æ–±—Ä–∞–≤ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É.
            
            ### –ö–û–ù–¢–ï–ö–°–¢ –ò –Ø–ó–´–ö–û–í–û–ô –ë–ê–†–¨–ï–†
            1. **–í—Ö–æ–¥—è—â–∏–π —è–∑—ã–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ —Ç–µ–±–µ –Ω–∞ **—Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ**.
            2. **–î–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥ (–Ω–∞–∑–≤–∞–Ω–∏—è, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ) –≤–µ–¥–µ—Ç—Å—è –Ω–∞ **–∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ**.
            3. **–¢–≤–æ—è —Å—É–ø–µ—Ä-—Å–∏–ª–∞:** –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –∫–∞–∫ "–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –º–æ—Å—Ç":
               - –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
               - –®–∞–≥ 2: –í—ã–¥–µ–ª—è–µ—à—å –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—à—å –∏—Ö –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ (Tools).
                 *–ü—Ä–∏–º–µ—Ä:* –ó–∞–ø—Ä–æ—Å "–ö–Ω–∏–≥–∏ –ø–æ –º–∞—à–∏–Ω–Ω–æ–º—É –æ–±—É—á–µ–Ω–∏—é –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤" -> –ü–æ–∏—Å–∫ "Machine Learning for beginners" –∏–ª–∏ "Intro to AI".
               - –®–∞–≥ 3: –ü–æ–ª—É—á–∏–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, —Ç—ã —Ñ–æ—Ä–º–∏—Ä—É–µ—à—å –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
            
            ### –ê–õ–ì–û–†–ò–¢–ú –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–ü–†–û–°–ê
            1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –≤—ã–±–æ—Ä–µ, –∑–∞–¥–∞–π 1-2 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ (—É—Ä–æ–≤–µ–Ω—å –∑–Ω–∞–Ω–∏–π, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞).
            2. –ò—Å–ø–æ–ª—å–∑—É–π –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (Tools) –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥ –ø–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–º –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.
            3. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∫–Ω–∏–≥–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω–∞—à–µ–ª –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
            4. –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∏—Å–∫ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –Ω–∞–∏–±–æ–ª–µ–µ –±–ª–∏–∑–∫–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, –æ–±—ä—è—Å–Ω–∏–≤, –ø–æ—á–µ–º—É –æ–Ω–∏ –ø–æ–¥—Ö–æ–¥—è—Ç.
            
            ### –ü–†–ê–í–ò–õ–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø –û–¢–í–ï–¢–ê
            –ö–∞–∂–¥–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –∫–Ω–∏–≥–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞ –≤ –∫—Ä–∞—Å–∏–≤–æ–º **Markdown** –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–±–ª–æ–Ω—É:
            
            ---
            **üìö [–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º]**
            *–ê–≤—Ç–æ—Ä: [–ò–º—è –ê–≤—Ç–æ—Ä–∞]*
            
            **üí∞ –¶–µ–Ω–∞:** [–¶–µ–Ω–∞] BYN
            
            **–û —á–µ–º —ç—Ç–∞ –∫–Ω–∏–≥–∞:**
            [–ö—Ä–∞—Ç–∫–∏–π, –µ–º–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑ —Å—É—Ç–∏ –∫–Ω–∏–≥–∏ –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ. –ù–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤–æ–¥–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é, –∞ –≤—ã–¥–µ–ª–∏ –ø–æ–ª—å–∑—É –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª—è.]
            
            **–ü–æ—á–µ–º—É —è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é:**
            [–¢–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —ç–∫—Å–ø–µ—Ä—Ç–∞: –ø–æ—á–µ–º—É —ç—Ç–∞ –∫–Ω–∏–≥–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.]
            ---
            
            ### –í–ê–ñ–ù–´–ï –£–ö–ê–ó–ê–ù–ò–Ø
            - **–í–∞–ª—é—Ç–∞:** –í—Å–µ —Ü–µ–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∫–∞–∑–∞–Ω—ã —Å—Ç—Ä–æ–≥–æ –≤ **BYN**. –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—É –≤ –¥—Ä—É–≥–æ–π –≤–∞–ª—é—Ç–µ, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π –µ—ë (–∏–ª–∏ —É–∫–∞–∑—ã–≤–∞–π –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞, –Ω–æ —Å –ø–æ–º–µ—Ç–∫–æ–π).
            - **–¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π —Å–ª–µ–Ω–≥ (—Ñ–∏—á–∏, –¥–µ–ø–ª–æ–π, –±—ç–∫–µ–Ω–¥), –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ, –Ω–æ –æ–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –Ω–æ–≤–∏—á–∫–∞–º.
            - **–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è:** –ù–∞–∑–≤–∞–Ω–∏—è –∫–Ω–∏–≥ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–ª—è–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (—Ç–∞–∫ –∏—Ö –ª–µ–≥—á–µ –≥—É–≥–ª–∏—Ç—å –∏–ª–∏ –Ω–∞–π—Ç–∏ –Ω–∞ –ø–æ–ª–∫–µ), –Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∏.
            - **–í–µ–∂–ª–∏–≤–æ—Å—Ç—å:** –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (—É–º–µ—Ä–µ–Ω–Ω–æ), —á—Ç–æ–±—ã –æ–∂–∏–≤–∏—Ç—å –¥–∏–∞–ª–æ–≥.
            
            ### –ü–†–ò–ú–ï–†–´ –ü–û–í–ï–î–ï–ù–ò–Ø
            User: "–ü–æ—Å–æ–≤–µ—Ç—É–π —á—Ç–æ-—Ç–æ –ø–æ –î–∂–∞–≤–µ –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö."
            Thought: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç Advanced Java. –ò—â—É: "Java Advanced", "Java Concurrency", "Java Performance".
            Response: (–í—ã–¥–∞–µ—à—å —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ —Å —Ä—É—Å—Å–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä "Effective Java").
            
            User: "–ï—Å—Ç—å –∫–Ω–∏–≥–∏ –ø—Ä–æ –ö—É–±–µ—Ä–Ω–µ—Ç–µ—Å?"
            Thought: –ò—â—É "Kubernetes", "K8s", "Cloud Native".
            Response: (–°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ —Å —Ü–µ–Ω–∞–º–∏ –≤ BYN).
            """)
    String chat(@V("username") String username, @UserMessage String userMessage);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\infrastructure\config\AssistantConfig.java
============================================================

package com.bsuir.book_store.assistant.infrastructure.config;

import com.bsuir.book_store.assistant.application.BookStoreAssistant;
import com.bsuir.book_store.assistant.infrastructure.tools.CatalogAiTools;
import com.bsuir.book_store.assistant.infrastructure.tools.OrderAiTools;
import dev.langchain4j.memory.chat.ChatMemoryProvider;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.openai.OpenAiChatModel;
import dev.langchain4j.service.AiServices;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.time.Duration;

@Configuration
public class AssistantConfig {

    @Bean
    public ChatLanguageModel chatLanguageModel() {
        return OpenAiChatModel.builder()
                .baseUrl("http://langchain4j.dev/demo/openai/v1")
                .apiKey("demo")
                .modelName("gpt-4o-mini")
                .timeout(Duration.ofSeconds(60))
                .logRequests(true)
                .logResponses(true)
                .build();
    }

    @Bean
    public ChatMemoryProvider chatMemoryProvider() {
        return chatId -> MessageWindowChatMemory.withMaxMessages(10);
    }

    @Bean
    public BookStoreAssistant bookStoreAssistant(
            ChatLanguageModel chatLanguageModel,
            CatalogAiTools catalogAiTools,
            OrderAiTools orderAiTools,
            ChatMemoryProvider chatMemoryProvider
    ) {
        return AiServices.builder(BookStoreAssistant.class)
                .chatLanguageModel(chatLanguageModel)
                .chatMemoryProvider(chatMemoryProvider)
                .tools(catalogAiTools, orderAiTools)
                .build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\infrastructure\tools\CatalogAiTools.java
============================================================

package com.bsuir.book_store.assistant.infrastructure.tools;

import com.bsuir.book_store.catalog.application.CatalogQueryService;
import com.bsuir.book_store.catalog.domain.document.BookDocument;
import dev.langchain4j.agent.tool.Tool;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.stream.Collectors;

@Component
@RequiredArgsConstructor
public class CatalogAiTools {

    private final CatalogQueryService catalogQueryService;

    @Tool("""
          –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –ø–µ—Ä–≤—ã–º –ø—Ä–∏ –ª—é–±–æ–º –∑–∞–ø—Ä–æ—Å–µ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã.
          
          –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –í–´–ó–û–í–ê:
          1. –ü–ï–†–ï–í–û–î: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–Ω–∏–≥–∏ –¢–û–õ–¨–ö–û –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.
             –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∫–Ω–∏–≥–∏ –ø–æ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ Java"),
             —Ç—ã –û–ë–Ø–ó–ê–ù –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å—É—Ç—å –≤ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "Java Concurrency" –∏–ª–∏ "Multithreading").
          2. –û–ß–ò–°–¢–ö–ê: –£–±–∏—Ä–∞–π —Å–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã ("–ø–æ—Å–æ–≤–µ—Ç—É–π", "–∫–∞–∫–∏–µ –µ—Å—Ç—å", "—Ö–æ—á—É –ø–æ—á–∏—Ç–∞—Ç—å").
             –û—Å—Ç–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —Å—É—Ç—å: —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, —è–∑—ã–∫–∏, –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∞–≤—Ç–æ—Ä–æ–≤.
          3. –ö–û–ù–¢–ï–ö–°–¢: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç "–¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö", –¥–æ–±–∞–≤—å –≤ –∑–∞–ø—Ä–æ—Å —Å–ª–æ–≤–∞ "Beginner", "Intro", "Head First".
          """)
    public String searchBooks(String query) {
        System.out.println("DEBUG: AI tool call searchBooks with query: '" + query + "'");

        List<BookDocument> results = catalogQueryService.search(query);

        if (results.isEmpty()) {
            return "–ü–æ –∑–∞–ø—Ä–æ—Å—É '" + query + "' –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
        }

        return results.stream()
                .limit(5)
                .map(b -> String.format("ID: %s | –ù–∞–∑–≤–∞–Ω–∏–µ: %s | –ê–≤—Ç–æ—Ä: %s | –¶–µ–Ω–∞: %s BYN | –û–ø–∏—Å–∞–Ω–∏–µ: %s",
                        b.getId(),
                        b.getTitle(),
                        String.join(", ", b.getAuthors()),
                        b.getPrice(),
                        truncate(b.getDescription(), 150)))
                .collect(Collectors.joining("\n---\n"));
    }

    @Tool("""
          –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª—Å—è –ö–û–ù–ö–†–ï–¢–ù–û–ô –∫–Ω–∏–≥–æ–π –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–∏—Å–∫–∞
          –∏ –ø—Ä–æ—Å–∏—Ç —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –Ω–µ–π –ø–æ–¥—Ä–æ–±–Ω–µ–µ (—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ, –ø–æ–ª–Ω–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è, –¥–µ—Ç–∞–ª–∏).
          
          –ê–†–ì–£–ú–ï–ù–¢–´:
          - –í 'titleOrId' –ø–µ—Ä–µ–¥–∞–≤–∞–π –¢–û–ß–ù–û–ï –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ç—ã –ø–æ–ª—É—á–∏–ª –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ searchBooks.
          """)
    public String getBookDetails(String titleOrId) {
        List<BookDocument> results = catalogQueryService.search(titleOrId);

        if (results.isEmpty()) return "–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.";

        BookDocument book = results.get(0);
        return String.format("""
                –ù–∞–∑–≤–∞–Ω–∏–µ: %s
                –ê–≤—Ç–æ—Ä—ã: %s
                –ñ–∞–Ω—Ä—ã: %s
                –¶–µ–Ω–∞: %s BYN
                –û–ø–∏—Å–∞–Ω–∏–µ: %s
                """,
                book.getTitle(),
                String.join(", ", book.getAuthors()),
                String.join(", ", book.getGenres()),
                book.getPrice(),
                book.getDescription()
        );
    }

    private String truncate(String text, int length) {
        if (text == null) return "";
        return text.length() > length ? text.substring(0, length) + "..." : text;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\assistant\infrastructure\tools\OrderAiTools.java
============================================================

package com.bsuir.book_store.assistant.infrastructure.tools;

import com.bsuir.book_store.orders.application.OrderService;
import com.bsuir.book_store.orders.domain.Order;
import dev.langchain4j.agent.tool.Tool;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.stream.Collectors;

@Component
@RequiredArgsConstructor
public class OrderAiTools {

    private final OrderService orderService;

    @Tool("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
    public String getMyLastOrders(String username) {
        try {
            List<Order> orders = orderService.getMyOrders(username);
            if (orders.isEmpty()) {
                return "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.";
            }

            return orders.stream()
                    .limit(3)
                    .map(o -> String.format("–ó–∞–∫–∞–∑ %s –æ—Ç %s. –°—Ç–∞—Ç—É—Å: %s. –°—É–º–º–∞: %s BYN",
                            o.getOrderNumber(),
                            o.getOrderDate(),
                            o.getStatus(),
                            o.getTotalCost()))
                    .collect(Collectors.joining("\n"));
        } catch (Exception e) {
            return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.";
        }
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\api\CatalogController.java
============================================================

package com.bsuir.book_store.catalog.api;

import com.bsuir.book_store.catalog.api.dto.CreateBookRequest;
import com.bsuir.book_store.catalog.api.dto.ImportBookRequest;
import com.bsuir.book_store.catalog.application.CatalogCommandService;
import com.bsuir.book_store.catalog.application.CatalogQueryService;
import com.bsuir.book_store.catalog.application.ImportBookService;
import com.bsuir.book_store.catalog.domain.document.BookDocument;
import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.shared.security.annotations.IsManager;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/api/catalog")
@RequiredArgsConstructor
@Tag(name = "Catalog", description = "–ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–æ–º")
public class CatalogController {

    private final ImportBookService importBookService;
    private final CatalogCommandService commandService;
    private final CatalogQueryService queryService;

    @Operation(summary = "–ò–º–ø–æ—Ä—Ç –∫–Ω–∏–≥–∏ (–ú–µ–Ω–µ–¥–∂–µ—Ä)", description = "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥–∏ –∏–∑ Google Books API –ø–æ ISBN")
    @PostMapping("/import")
    @IsManager
    public ResponseEntity<String> importBookFromExternalApi(@RequestBody ImportBookRequest request) {
        Book importedBook = importBookService.importBook(
                request.getIsbn(),
                request.getPrice(),
                request.getStock()
        );
        return ResponseEntity.ok("–ö–Ω–∏–≥–∞ '" + importedBook.getTitle() + "' —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å ID: " + importedBook.getId());
    }

    @Operation(summary = "–ü–æ–∏—Å–∫ –∫–Ω–∏–≥", description = "–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Elasticsearch (–ù–∞–∑–≤–∞–Ω–∏–µ, –ê–≤—Ç–æ—Ä, –û–ø–∏—Å–∞–Ω–∏–µ)")
    @GetMapping("/search")
    public ResponseEntity<List<BookDocument>> search(@RequestParam(required = false) String q) {
        return ResponseEntity.ok(queryService.search(q));
    }

    @Operation(summary = "–°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–∏–≥–∏", description = "–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∫–Ω–∏–≥—É –ø–æ –≤–≤–µ–¥–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º")
    @PostMapping("/books")
    @IsManager
    public ResponseEntity<UUID> createBook(@RequestBody CreateBookRequest request) {
        return ResponseEntity.ok(commandService.createBook(request));
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\api\dto\CreateBookRequest.java
============================================================

package com.bsuir.book_store.catalog.api.dto;

import lombok.Data;
import java.math.BigDecimal;
import java.util.List;
import java.util.UUID;

@Data
public class CreateBookRequest {
    private String title;
    private String description;
    private String isbn;
    private BigDecimal price;
    private int stock;
    private List<UUID> authorIds;
    private List<UUID> genreIds;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\api\dto\ImportBookRequest.java
============================================================

package com.bsuir.book_store.catalog.api.dto;

import lombok.Data;
import java.math.BigDecimal;

@Data
public class ImportBookRequest {
    private String isbn;
    private BigDecimal price;
    private int stock;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\application\CatalogCommandService.java
============================================================

package com.bsuir.book_store.catalog.application;

import com.bsuir.book_store.catalog.api.dto.CreateBookRequest;
import com.bsuir.book_store.catalog.application.sync.SearchSyncService;
import com.bsuir.book_store.catalog.domain.model.Author;
import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.domain.model.Genre;
import com.bsuir.book_store.catalog.infrastructure.AuthorRepository;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.catalog.infrastructure.GenreRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class CatalogCommandService {

    private final BookRepository bookRepository;
    private final AuthorRepository authorRepository;
    private final GenreRepository genreRepository;
    private final SearchSyncService searchSyncService;

    @Transactional
    public UUID createBook(CreateBookRequest request) {
        Set<Author> authors = new HashSet<>(authorRepository.findAllById(request.getAuthorIds()));
        Set<Genre> genres = new HashSet<>(genreRepository.findAllById(request.getGenreIds()));

        // 2. –°–æ–∑–¥–∞–µ–º —Å—É—â–Ω–æ—Å—Ç—å (Rich Model)
        Book book = Book.builder()
                .title(request.getTitle())
                .description(request.getDescription())
                .isbn(request.getIsbn())
                .cost(request.getPrice())
                .stockQuantity(request.getStock())
                .authors(authors)
                .genres(genres)
                .build();

        book = bookRepository.save(book);

        searchSyncService.syncBook(book);

        return book.getId();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\application\CatalogQueryService.java
============================================================

package com.bsuir.book_store.catalog.application;

import com.bsuir.book_store.catalog.domain.document.BookDocument;
import com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class CatalogQueryService {

    private final BookElasticRepository elasticRepository;

    public List<BookDocument> search(String query) {
        if (query == null || query.isBlank()) {
            List<BookDocument> result = new ArrayList<>();
            elasticRepository.findAll().forEach(result::add);
            return result;
        }

        return elasticRepository.searchByComplexQuery(query);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\application\ImportBookService.java
============================================================

package com.bsuir.book_store.catalog.application;

import com.bsuir.book_store.catalog.application.sync.SearchSyncService;
import com.bsuir.book_store.catalog.domain.model.Author;
import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.domain.model.Genre;
import com.bsuir.book_store.catalog.domain.model.Image;
import com.bsuir.book_store.catalog.domain.model.ImageType;
import com.bsuir.book_store.catalog.infrastructure.external.google.GoogleBooksClient;
import com.bsuir.book_store.catalog.infrastructure.external.google.GoogleBooksClient.GoogleBookDto;
import com.bsuir.book_store.catalog.infrastructure.AuthorRepository;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.catalog.infrastructure.GenreRepository;
import com.bsuir.book_store.catalog.infrastructure.ImageRepository;
import com.bsuir.book_store.shared.exception.DomainException;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.HashSet;
import java.util.Set;

@Service
@RequiredArgsConstructor
public class ImportBookService {

    private final GoogleBooksClient googleBooksClient;
    private final BookRepository bookRepository;
    private final AuthorRepository authorRepository;
    private final GenreRepository genreRepository;
    private final ImageRepository imageRepository;
    private final SearchSyncService searchSyncService;

    @Transactional
    public Book importBook(String isbn, BigDecimal defaultPrice, int defaultStock) {
        if (bookRepository.existsByIsbn(isbn)) {
            throw new DomainException("–ö–Ω–∏–≥–∞ —Å ISBN " + isbn + " —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ");
        }

        GoogleBookDto googleBook = googleBooksClient.fetchBookByIsbn(isbn);

        Set<Author> authors = new HashSet<>();
        if (googleBook.getAuthors() != null) {
            for (String authorName : googleBook.getAuthors()) {
                Author author = authorRepository.findByName(authorName)
                        .orElseGet(() -> authorRepository.save(
                                Author.builder().name(authorName).build()
                        ));
                authors.add(author);
            }
        }

        Set<Genre> genres = new HashSet<>();
        if (googleBook.getCategories() != null) {
            for (String categoryName : googleBook.getCategories()) {
                Genre genre = genreRepository.findByName(categoryName)
                        .orElseGet(() -> genreRepository.save(
                                Genre.builder().name(categoryName).build()
                        ));
                genres.add(genre);
            }
        }

        if (googleBook.getImageLinks() != null && googleBook.getImageLinks().getThumbnail() != null) {
            Image cover = Image.builder()
                    .url(googleBook.getImageLinks().getThumbnail())
                    .imageType(ImageType.COVER)
                    .build();
            imageRepository.save(cover);
        }

        Book book = Book.builder()
                .title(googleBook.getTitle())
                .description(googleBook.getDescription())
                .isbn(isbn)
                .cost(defaultPrice)
                .stockQuantity(defaultStock)
                .authors(authors)
                .genres(genres)
                .build();

        book = bookRepository.save(book);
        searchSyncService.syncBook(book);

        return book;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\application\sync\SearchSyncService.java
============================================================

package com.bsuir.book_store.catalog.application.sync;

import com.bsuir.book_store.catalog.domain.document.BookDocument;
import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.elastic.BookElasticRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
public class SearchSyncService {

    private final BookElasticRepository elasticRepository;

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void syncBook(Book book) {
        BookDocument doc = BookDocument.builder()
                .id(book.getId().toString())
                .title(book.getTitle())
                .description(book.getDescription())
                .isbn(book.getIsbn())
                .price(book.getCost())
                .authors(book.getAuthors().stream().map(a -> a.getName()).toList())
                .genres(book.getGenres().stream().map(g -> g.getName()).toList())
                .build();

        elasticRepository.save(doc);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\document\BookDocument.java
============================================================

package com.bsuir.book_store.catalog.domain.document;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.elasticsearch.annotations.Document;
import org.springframework.data.elasticsearch.annotations.Field;
import org.springframework.data.elasticsearch.annotations.FieldType;

import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
@Document(indexName = "books")
public class BookDocument {

    @Id
    private String id;

    @Field(type = FieldType.Text, analyzer = "standard")
    private String title;

    @Field(type = FieldType.Text)
    private String description;

    @Field(type = FieldType.Keyword)
    private String isbn;

    @Field(type = FieldType.Double)
    private BigDecimal price;

    @Field(type = FieldType.Text)
    private List<String> authors;

    @Field(type = FieldType.Keyword)
    private List<String> genres;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Author.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import jakarta.persistence.*;
import lombok.*;
import java.util.UUID;

@Entity
@Table(name = "authors")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Author {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String name;

    @Column(columnDefinition = "TEXT")
    private String biography;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Book.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import com.bsuir.book_store.shared.exception.DomainException;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.math.BigDecimal;
import java.sql.Timestamp;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

@Entity
@Table(name = "books")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Book {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String title;

    @Column(unique = true)
    private String isbn;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column(name = "stock_quantity", nullable = false)
    private int stockQuantity;

    @Column(nullable = false)
    private BigDecimal cost;

    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
            name = "book_authors",
            joinColumns = @JoinColumn(name = "book_id"),
            inverseJoinColumns = @JoinColumn(name = "author_id")
    )
    private Set<Author> authors = new HashSet<>();

    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
            name = "book_genres",
            joinColumns = @JoinColumn(name = "book_id"),
            inverseJoinColumns = @JoinColumn(name = "genre_id")
    )
    private Set<Genre> genres = new HashSet<>();

    @CreationTimestamp
    private Timestamp createdAt;

    @UpdateTimestamp
    private Timestamp updatedAt;

    public void reserveStock(int quantity) {
        if (quantity <= 0) throw new DomainException("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º");
        if (this.stockQuantity < quantity) {
            throw new DomainException("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ '" + title + "' –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: " + stockQuantity);
        }
        this.stockQuantity -= quantity;
    }

    public void releaseStock(int quantity) {
        this.stockQuantity += quantity;
    }

    public void updatePrice(BigDecimal newPrice) {
        if (newPrice.compareTo(BigDecimal.ZERO) < 0) throw new DomainException("–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π");
        this.cost = newPrice;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Genre.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import jakarta.persistence.*;
import lombok.*;
import java.util.UUID;

@Entity
@Table(name = "genres")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Genre {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String name;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Image.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.CreationTimestamp;
import java.sql.Timestamp;
import java.util.UUID;

@Entity
@Table(name = "images")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Image {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String url;

    @Enumerated(EnumType.STRING)
    @Column(name = "image_type")
    private ImageType imageType;

    @CreationTimestamp
    @Column(name = "created_at")
    private Timestamp createdAt;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\ImageType.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

public enum ImageType {
    COVER,
    ILLUSTRATION,
    AUTHOR_PHOTO,
    LOGO
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\domain\model\Publisher.java
============================================================

package com.bsuir.book_store.catalog.domain.model;

import jakarta.persistence.*;
import lombok.*;
import java.util.UUID;

@Entity
@Table(name = "publishers")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Publisher {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(nullable = false)
    private String name;

    @Column(columnDefinition = "TEXT")
    private String description;

    @ManyToOne
    @JoinColumn(name = "logo_image_id")
    private Image logo;
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\AuthorRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Author;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;
import java.util.UUID;

public interface AuthorRepository extends JpaRepository<Author, UUID> {
    Optional<Author> findByName(String name);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\BookRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Book;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.UUID;

public interface BookRepository extends JpaRepository<Book, UUID> {
    boolean existsByIsbn(String isbn);
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\GenreRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Genre;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;
import java.util.UUID;

public interface GenreRepository extends JpaRepository<Genre, UUID> {
    Optional<Genre> findByName(String name);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\ImageRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Image;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.UUID;

public interface ImageRepository extends JpaRepository<Image, UUID> {
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\PublisherRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure;

import com.bsuir.book_store.catalog.domain.model.Publisher;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.UUID;

public interface PublisherRepository extends JpaRepository<Publisher, UUID> {
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\elastic\BookElasticRepository.java
============================================================

package com.bsuir.book_store.catalog.infrastructure.elastic;


import org.springframework.data.elasticsearch.annotations.Query;
import com.bsuir.book_store.catalog.domain.document.BookDocument;
import org.springframework.data.elasticsearch.repository.ElasticsearchRepository;
import java.util.List;

public interface BookElasticRepository extends ElasticsearchRepository<BookDocument, String> {
    @Query("{\"multi_match\": {\"query\": \"?0\", \"fields\": [\"title^3\", \"authors^2\", \"description\"], \"fuzziness\": \"AUTO\"}}")
    List<BookDocument> searchByComplexQuery(String query);
    List<BookDocument> findByGenresIn(List<String> genres);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\catalog\infrastructure\external\google\GoogleBooksClient.java
============================================================

package com.bsuir.book_store.catalog.infrastructure.external.google;

import com.bsuir.book_store.shared.exception.DomainException;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.util.List;

@Component
@RequiredArgsConstructor
public class GoogleBooksClient {

    private final RestTemplate restTemplate = new RestTemplate();
    private static final String GOOGLE_BOOKS_API_URL = "https://www.googleapis.com/books/v1/volumes?q=isbn:";

    public GoogleBookDto fetchBookByIsbn(String isbn) {
        String url = GOOGLE_BOOKS_API_URL + isbn;

        try {
            GoogleResponse response = restTemplate.getForObject(url, GoogleResponse.class);

            if (response == null || response.getItems() == null || response.getItems().isEmpty()) {
                throw new DomainException("–ö–Ω–∏–≥–∞ —Å ISBN " + isbn + " –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Google Books");
            }

            return response.getItems().get(0).getVolumeInfo();

        } catch (Exception e) {
            throw new DomainException("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Google Books API: " + e.getMessage());
        }
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class GoogleResponse {
        private List<Item> items;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Item {
        private GoogleBookDto volumeInfo;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class GoogleBookDto {
        private String title;
        private List<String> authors;
        private String description;
        private List<String> categories; // –≠—Ç–æ –±—É–¥—É—Ç –Ω–∞—à–∏ –∂–∞–Ω—Ä—ã
        private List<IndustryIdentifier> industryIdentifiers;
        private ImageLinks imageLinks;
        private Integer pageCount;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class IndustryIdentifier {
        private String type;
        private String identifier;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class ImageLinks {
        private String thumbnail;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\api\OrderController.java
============================================================

package com.bsuir.book_store.orders.api;

import com.bsuir.book_store.orders.api.dto.CreateOrderRequest;
import com.bsuir.book_store.orders.application.OrderService;
import com.bsuir.book_store.orders.domain.Order;
import com.bsuir.book_store.orders.domain.OrderStatus;
import com.bsuir.book_store.shared.security.annotations.IsManager;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/api/orders")
@RequiredArgsConstructor
@Tag(name = "Orders", description = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏")
public class OrderController {

    private final OrderService orderService;

    @Operation(summary = "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", description = "–°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ –∫–Ω–∏–≥ –∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç–∞–≤–∫–µ")
    @PostMapping
    public ResponseEntity<UUID> createOrder(
            @RequestBody CreateOrderRequest request,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        return ResponseEntity.ok(orderService.createOrder(request, userDetails.getUsername()));
    }

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å –º–æ–∏ –∑–∞–∫–∞–∑—ã", description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    @GetMapping("/my")
    public ResponseEntity<List<Order>> getMyOrders(
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        return ResponseEntity.ok(orderService.getMyOrders(userDetails.getUsername()));
    }

    @Operation(summary = "–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã (–ú–µ–Ω–µ–¥–∂–µ—Ä)", description = "–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ä–æ–ª—å—é MANAGER")
    @GetMapping
    @IsManager
    public ResponseEntity<List<Order>> getAllOrders() {
        return ResponseEntity.ok(orderService.getAllOrders());
    }

    @Operation(summary = "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞", description = "–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π")
    @PatchMapping("/{id}/status")
    @IsManager
    public ResponseEntity<Void> updateStatus(
            @PathVariable UUID id,
            @RequestParam OrderStatus status
    ) {
        orderService.changeStatus(id, status);
        return ResponseEntity.ok().build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\api\dto\CreateOrderRequest.java
============================================================

package com.bsuir.book_store.orders.api.dto;

import lombok.Data;
import java.util.List;
import java.util.UUID;

@Data
public class CreateOrderRequest {
    private List<ItemDto> items;
    private DeliveryDto deliveryDetails;

    @Data
    public static class ItemDto {
        private UUID bookId;
        private int quantity;
    }

    @Data
    public static class DeliveryDto {
        private String customerName;
        private String phone;
        private String address;
        private String timeSlot;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\application\OrderService.java
============================================================

package com.bsuir.book_store.orders.application;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.orders.api.dto.CreateOrderRequest;
import com.bsuir.book_store.orders.domain.DeliveryDetails;
import com.bsuir.book_store.orders.domain.Order;
import com.bsuir.book_store.orders.domain.OrderStatus;
import com.bsuir.book_store.orders.infrastructure.OrderRepository;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.sql.Date;
import java.time.LocalDate;
import java.util.List;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;
    private final BookRepository bookRepository;
    private final UserRepository userRepository;

    @Transactional
    public UUID createOrder(CreateOrderRequest request, String username) {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new DomainException("User not found"));

        Order order = Order.create(user);

        for (var itemRequest : request.getItems()) {
            Book book = bookRepository.findById(itemRequest.getBookId())
                    .orElseThrow(() -> new DomainException("Book not found: " + itemRequest.getBookId()));

            book.reserveStock(itemRequest.getQuantity());

            order.addItem(book, itemRequest.getQuantity());

            bookRepository.save(book);
        }

        DeliveryDetails delivery = DeliveryDetails.builder()
                .customerName(request.getDeliveryDetails().getCustomerName())
                .contactPhone(request.getDeliveryDetails().getPhone())
                .addressText(request.getDeliveryDetails().getAddress())
                .deliveryTimeSlot(request.getDeliveryDetails().getTimeSlot())
                .deliveryDate(Date.valueOf(LocalDate.now().plusDays(1))) // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–∞—Ç—ã
                .build();

        order.attachDeliveryDetails(delivery);

        return orderRepository.save(order).getId();
    }

    @Transactional
    public void changeStatus(UUID orderId, OrderStatus newStatus) {
        Order order = orderRepository.findById(orderId)
                .orElseThrow(() -> new DomainException("Order not found"));

        order.updateStatus(newStatus);

        orderRepository.save(order);
    }

    @Transactional(readOnly = true)
    public List<Order> getAllOrders() {
        return orderRepository.findAllByOrderByCreatedAtDesc();
    }

    @Transactional(readOnly = true)
    public List<Order> getMyOrders(String username) {
        return orderRepository.findByUserUsernameOrderByCreatedAtDesc(username);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\domain\DeliveryDetails.java
============================================================

package com.bsuir.book_store.orders.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import java.sql.Date;
import java.util.UUID;

@Entity
@Table(name = "delivery_details")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class DeliveryDetails {
    @Id
    @Column(name = "order_id")
    private UUID orderId;

    @JsonIgnore
    @OneToOne
    @MapsId
    @JoinColumn(name = "order_id")
    private Order order;

    @Column(name = "customer_name", nullable = false)
    private String customerName;

    @Column(name = "contact_phone", nullable = false)
    private String contactPhone;

    @Column(name = "address_text", columnDefinition = "TEXT", nullable = false)
    private String addressText;

    @Column(name = "delivery_time_slot")
    private String deliveryTimeSlot;

    @Column(name = "delivery_date")
    private Date deliveryDate;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\domain\Order.java
============================================================

package com.bsuir.book_store.orders.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.math.BigDecimal;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@Entity
@Table(name = "orders")
@Getter
@NoArgsConstructor
public class Order {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(name = "order_number", unique = true, nullable = false)
    private String orderNumber;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private OrderStatus status;

    @Column(name = "total_cost", nullable = false)
    private BigDecimal totalCost;

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<OrderItem> orderItems = new ArrayList<>();

    @OneToOne(mappedBy = "order", cascade = CascadeType.ALL, orphanRemoval = true)
    private DeliveryDetails deliveryDetails;

    @Column(name = "order_date")
    private Timestamp orderDate;

    @CreationTimestamp
    private Timestamp createdAt;

    @UpdateTimestamp
    private Timestamp updatedAt;

    public static Order create(User user) {
        Order order = new Order();
        order.id = UUID.randomUUID();
        order.user = user;
        order.status = OrderStatus.NEW;
        order.orderNumber = "ORD-" + UUID.randomUUID().toString().substring(0, 8).toUpperCase();
        order.totalCost = BigDecimal.ZERO;
        order.orderItems = new ArrayList<>();
        order.orderDate = Timestamp.valueOf(LocalDateTime.now());
        return order;
    }

    public void addItem(Book book, int quantity) {
        if (quantity <= 0) {
            throw new DomainException("Quantity must be greater than zero");
        }

        OrderItem item = OrderItem.builder()
                .id(UUID.randomUUID())
                .order(this)
                .book(book)
                .bookTitle(book.getTitle())
                .isbn(book.getIsbn())
                .quantity(quantity)
                .pricePerItem(book.getCost())
                .build();

        this.orderItems.add(item);
        recalculateTotal();
    }

    public void attachDeliveryDetails(DeliveryDetails details) {
        if (details == null) throw new DomainException("Delivery details cannot be empty");
        this.deliveryDetails = details;
        details.setOrder(this); // –°–≤—è–∑—ã–≤–∞–µ–º –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Å–≤—è–∑—å
    }

    public void updateStatus(OrderStatus newStatus) {
        if (this.status == OrderStatus.DELIVERED && newStatus == OrderStatus.CANCELLED) {
            throw new DomainException("Cannot cancel an already delivered order");
        }
        if (this.status == OrderStatus.CANCELLED) {
            throw new DomainException("Cannot change status of a cancelled order");
        }
        this.status = newStatus;
    }

    private void recalculateTotal() {
        this.totalCost = orderItems.stream()
                .map(OrderItem::getTotalPrice)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\domain\OrderItem.java
============================================================

package com.bsuir.book_store.orders.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;
import java.util.UUID;

@Entity
@Table(name = "order_items")
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrderItem {
    @Id
    private UUID id;

    @JsonIgnore
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id")
    private Order order;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "book_id")
    private Book book;

    @Column(name = "book_title")
    private String bookTitle;

    private String isbn;

    private Integer quantity;

    @Column(name = "price_per_item")
    private BigDecimal pricePerItem;

    public BigDecimal getTotalPrice() {
        return pricePerItem.multiply(BigDecimal.valueOf(quantity));
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\domain\OrderStatus.java
============================================================

package com.bsuir.book_store.orders.domain;

public enum OrderStatus {
    NEW, PROCESSING, SHIPPED, DELIVERED, CANCELLED
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\orders\infrastructure\OrderRepository.java
============================================================

package com.bsuir.book_store.orders.infrastructure;

import com.bsuir.book_store.orders.domain.Order;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;
import java.util.UUID;

public interface OrderRepository extends JpaRepository<Order, UUID> {
    List<Order> findByUserUsernameOrderByCreatedAtDesc(String username);
    List<Order> findAllByOrderByCreatedAtDesc();
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\api\ReviewController.java
============================================================

package com.bsuir.book_store.reviews.api;

import com.bsuir.book_store.reviews.api.dto.CreateReviewRequest;
import com.bsuir.book_store.reviews.application.ReviewService;
import com.bsuir.book_store.reviews.domain.Review;
import com.bsuir.book_store.shared.security.annotations.IsManager;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/api/reviews")
@RequiredArgsConstructor
@Tag(name = "Reviews", description = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏ –∏ —Ä–µ–π—Ç–∏–Ω–≥–∞–º–∏")
public class ReviewController {

    private final ReviewService reviewService;

    @Operation(
            summary = "–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤",
            description = "–î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–∑—ã–≤ –∫ –∫–Ω–∏–≥–µ –æ—Ç –∏–º–µ–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è."
    )
    @PostMapping
    public ResponseEntity<UUID> addReview(
            @RequestBody CreateReviewRequest request,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        return ResponseEntity.ok(reviewService.addReview(request, userDetails.getUsername()));
    }

    @Operation(
            summary = "–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–∑—ã–≤—ã –∫–Ω–∏–≥–∏",
            description = "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–Ω–∏–≥–∏, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ."
    )
    @GetMapping("/book/{bookId}")
    public ResponseEntity<List<Review>> getBookReviews(@PathVariable UUID bookId) {
        return ResponseEntity.ok(reviewService.getReviewsForBook(bookId));
    }

    @Operation(
            summary = "–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤ (–ú–æ–¥–µ—Ä–∞—Ü–∏—è)",
            description = "–£–¥–∞–ª—è–µ—Ç –æ—Ç–∑—ã–≤ –ø–æ ID. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–æ–ª–∏ MANAGER."
    )
    @DeleteMapping("/{id}")
    @IsManager
    public ResponseEntity<Void> deleteReview(@PathVariable UUID id) {
        reviewService.deleteReview(id);
        return ResponseEntity.noContent().build();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\api\dto\CreateReviewRequest.java
============================================================

package com.bsuir.book_store.reviews.api.dto;

import lombok.Data;
import java.util.UUID;

@Data
public class CreateReviewRequest {
    private UUID bookId;
    private Integer rating;
    private String text;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\application\ReviewService.java
============================================================

package com.bsuir.book_store.reviews.application;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.catalog.infrastructure.BookRepository;
import com.bsuir.book_store.reviews.api.dto.CreateReviewRequest;
import com.bsuir.book_store.reviews.domain.Review;
import com.bsuir.book_store.reviews.infrastructure.ReviewRepository;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class ReviewService {

    private final ReviewRepository reviewRepository;
    private final BookRepository bookRepository;
    private final UserRepository userRepository;

    @Transactional
    public UUID addReview(CreateReviewRequest request, String username) {
        if (reviewRepository.existsByBookIdAndUserUsername(request.getBookId(), username)) {
            throw new DomainException("–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç—É –∫–Ω–∏–≥—É");
        }

        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new DomainException("User not found"));

        Book book = bookRepository.findById(request.getBookId())
                .orElseThrow(() -> new DomainException("Book not found"));

        Review review = Review.leave(
                user,
                book,
                request.getRating(),
                request.getText()
        );

        return reviewRepository.save(review).getId();
    }

    @Transactional
    public void deleteReview(UUID reviewId) {
        if (!reviewRepository.existsById(reviewId)) {
            throw new DomainException("Review not found");
        }
        reviewRepository.deleteById(reviewId);
    }

    @Transactional(readOnly = true)
    public List<Review> getReviewsForBook(UUID bookId) {
        return reviewRepository.findAllByBookIdOrderByCreatedAtDesc(bookId);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\domain\Review.java
============================================================

package com.bsuir.book_store.reviews.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.shared.exception.DomainException;
import com.bsuir.book_store.users.domain.User;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.sql.Timestamp;
import java.util.UUID;

@Entity
@Table(name = "reviews")
@Getter
@NoArgsConstructor
public class Review {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "book_id", nullable = false)
    private Book book;

    @Column(nullable = false)
    private Integer rating; // 1-5

    @Column(columnDefinition = "TEXT", nullable = false)
    private String text;

    @CreationTimestamp
    @Column(name = "created_at", updatable = false)
    private Timestamp createdAt;

    @UpdateTimestamp
    @Column(name = "updated_at")
    private Timestamp updatedAt;

    public static Review leave(User user, Book book, int rating, String text) {
        validateRating(rating);
        validateText(text);

        Review review = new Review();
        review.id = UUID.randomUUID();
        review.user = user;
        review.book = book;
        review.rating = rating;
        review.text = text;

        return review;
    }

    public void updateContent(int newRating, String newText) {
        validateRating(newRating);
        validateText(newText);

        this.rating = newRating;
        this.text = newText;
    }

    private static void validateRating(int rating) {
        if (rating < 1 || rating > 5) {
            throw new DomainException("–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5");
        }
    }

    private static void validateText(String text) {
        if (text == null || text.isBlank()) {
            throw new DomainException("–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
        }
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\reviews\infrastructure\ReviewRepository.java
============================================================

package com.bsuir.book_store.reviews.infrastructure;

import com.bsuir.book_store.reviews.domain.Review;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;
import java.util.UUID;

public interface ReviewRepository extends JpaRepository<Review, UUID> {
    List<Review> findAllByBookIdOrderByCreatedAtDesc(UUID bookId);
    boolean existsByBookIdAndUserUsername(UUID bookId, String username);
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\config\ApplicationConfig.java
============================================================

package com.bsuir.book_store.shared.config;

import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
@RequiredArgsConstructor
public class ApplicationConfig {
    private final UserRepository userRepository;

    @Bean
    public UserDetailsService userDetailsService() {
        return username -> userRepository.findByUsername(username)
                .orElseThrow(() -> new UsernameNotFoundException("User not found with username: " + username));
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\config\OpenApiConfig.java
============================================================

package com.bsuir.book_store.shared.config;

import io.swagger.v3.oas.annotations.OpenAPIDefinition;
import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;
import io.swagger.v3.oas.annotations.info.Contact;
import io.swagger.v3.oas.annotations.info.Info;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.security.SecurityScheme;
import org.springframework.context.annotation.Configuration;

@Configuration
@OpenAPIDefinition(
        info = @Info(
                title = "Book Platform API",
                version = "1.0.0",
                description = "API –¥–ª—è –∫–Ω–∏–∂–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞: –∫–∞—Ç–∞–ª–æ–≥, –∫–æ—Ä–∑–∏–Ω–∞, –∑–∞–∫–∞–∑—ã, AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç",
                contact = @Contact(
                        name = "BSUIR Student",
                        email = "student@bsuir.by"
                )
        ),
        security = @SecurityRequirement(name = "JWT")
)
@SecurityScheme(
        name = "JWT",
        type = SecuritySchemeType.HTTP,
        bearerFormat = "JWT",
        scheme = "bearer",
        description = "–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à —Ç–æ–∫–µ–Ω"
)
public class OpenApiConfig {
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\config\SecurityConfig.java
============================================================

package com.bsuir.book_store.shared.config;

import com.bsuir.book_store.shared.security.JwtAuthenticationFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
@EnableMethodSecurity
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtAuthFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.csrf(AbstractHttpConfigurer::disable)
                .authorizeHttpRequests(req -> req
                        .requestMatchers("/api/auth/**").permitAll()
                        .requestMatchers(HttpMethod.GET, "/api/catalog/search").permitAll() // 2. –ü—É–±–ª–∏—á–Ω—ã–µ (—á–∞—Å—Ç–∏—á–Ω–æ)
                        .requestMatchers(
                                "/v3/api-docs/**",
                                "/swagger-ui/**",
                                "/swagger-ui.html"
                        ).permitAll()
                        .anyRequest().authenticated()
                )
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\exception\DomainException.java
============================================================

package com.bsuir.book_store.shared.exception;

import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ResponseStatus;

@ResponseStatus(HttpStatus.BAD_REQUEST)
public class DomainException extends RuntimeException {

    public DomainException(String message) {
        super(message);
    }

    public DomainException(String message, Throwable cause) {
        super(message, cause);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\exception\GlobalExceptionHandler.java
============================================================

package com.bsuir.book_store.shared.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.authorization.AuthorizationDeniedException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(DomainException.class)
    public ResponseEntity<Object> handleDomainException(DomainException ex) {
        return buildErrorResponse(ex.getMessage(), HttpStatus.BAD_REQUEST);
    }

    @ExceptionHandler({jakarta.persistence.EntityNotFoundException.class})
    public ResponseEntity<Object> handleNotFoundException(Exception ex) {
        return buildErrorResponse(ex.getMessage(), HttpStatus.NOT_FOUND);
    }

    @ExceptionHandler({AccessDeniedException.class, AuthorizationDeniedException.class})
    public ResponseEntity<Object> handleAccessDeniedException(Exception ex) {
        return buildErrorResponse("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω: —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏", HttpStatus.FORBIDDEN);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<Object> handleGlobalException(Exception ex) {
        ex.printStackTrace();
        return buildErrorResponse("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + ex.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);
    }

    private ResponseEntity<Object> buildErrorResponse(String message, HttpStatus status) {
        Map<String, Object> body = new HashMap<>();
        body.put("timestamp", LocalDateTime.now());
        body.put("status", status.value());
        body.put("error", status.getReasonPhrase());
        body.put("message", message);

        return new ResponseEntity<>(body, status);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\security\JwtAuthenticationFilter.java
============================================================

package com.bsuir.book_store.shared.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.lang.NonNull;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtService jwtService;
    private final UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(
            @NonNull HttpServletRequest request,
            @NonNull HttpServletResponse response,
            @NonNull FilterChain filterChain
    ) throws ServletException, IOException {

        final String authHeader = request.getHeader("Authorization");

        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        final String jwt = authHeader.substring(7);
        final String username = jwtService.extractUsername(jwt);

        if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = this.userDetailsService.loadUserByUsername(username);

            if (jwtService.isTokenValid(jwt, userDetails)) {
                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(
                        userDetails,
                        null,
                        userDetails.getAuthorities()
                );
                authToken.setDetails(
                        new WebAuthenticationDetailsSource().buildDetails(request)
                );
                SecurityContextHolder.getContext().setAuthentication(authToken);
            }
        }
        filterChain.doFilter(request, response);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\security\JwtService.java
============================================================

package com.bsuir.book_store.shared.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;

@Service
public class JwtService {

    @Value("${application.security.jwt.secret-key}")
    private String secretKey;

    @Value("${application.security.jwt.expiration}")
    private long jwtExpiration;

    public String extractUsername(String token) {
        return extractClaim(token, Claims::getSubject);
    }

    public <T> T extractClaim(String token, Function<Claims, T> claimsResolver) {
        final Claims claims = extractAllClaims(token);
        return claimsResolver.apply(claims);
    }

    public String generateToken(UserDetails userDetails) {
        return generateToken(new HashMap<>(), userDetails);
    }

    public String generateToken(Map<String, Object> extraClaims, UserDetails userDetails) {
        return Jwts
                .builder()
                .setClaims(extraClaims)
                .setSubject(userDetails.getUsername())
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + jwtExpiration))
                .signWith(getSignInKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    public boolean isTokenValid(String token, UserDetails userDetails) {
        final String username = extractUsername(token);
        return (username.equals(userDetails.getUsername())) && !isTokenExpired(token);
    }

    private boolean isTokenExpired(String token) {
        return extractExpiration(token).before(new Date());
    }

    private Date extractExpiration(String token) {
        return extractClaim(token, Claims::getExpiration);
    }

    private Claims extractAllClaims(String token) {
        return Jwts
                .parserBuilder()
                .setSigningKey(getSignInKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    private Key getSignInKey() {
        byte[] keyBytes = Decoders.BASE64.decode(secretKey);
        return Keys.hmacShaKeyFor(keyBytes);
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\security\annotations\IsManager.java
============================================================

package com.bsuir.book_store.shared.security.annotations;

import org.springframework.security.access.prepost.PreAuthorize;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("hasAuthority('MANAGER')")
public @interface IsManager {
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\shared\startup\DataInitializer.java
============================================================

package com.bsuir.book_store.shared.startup;

import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.CommandLineRunner;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
@Slf4j
public class DataInitializer implements CommandLineRunner {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    @Value("${manager.password}")
    private String managerPassword;

    @Override
    public void run(String... args) throws Exception {
        if (userRepository.findByRole(Role.MANAGER).isEmpty()) {
            log.info("No managers found. Creating a default manager account...");
            User manager = User.builder()
                    .username("manager")
                    .email("manager@bookstore.com")
                    .password(passwordEncoder.encode(managerPassword))
                    .role(Role.MANAGER)
                    .build();
            userRepository.save(manager);
            log.info("Default manager account created with username 'manager'");
        }
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\AuthenticationController.java
============================================================

package com.bsuir.book_store.users.api;

import com.bsuir.book_store.users.api.dto.AuthenticationRequest;
import com.bsuir.book_store.users.api.dto.AuthenticationResponse;
import com.bsuir.book_store.users.api.dto.RegisterRequest;
import com.bsuir.book_store.users.application.AuthenticationService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirements;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
@Tag(name = "Authentication", description = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
@SecurityRequirements()
public class AuthenticationController {

    private final AuthenticationService authenticationService;

    @Operation(summary = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", description = "–°–æ–∑–¥–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω")
    @PostMapping("/register")
    public ResponseEntity<AuthenticationResponse> register(
            @RequestBody RegisterRequest request
    ) {
        return ResponseEntity.ok(authenticationService.register(request));
    }

    @Operation(summary = "–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è", description = "–í—Ö–æ–¥ –ø–æ username/password –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞")
    @PostMapping("/authenticate")
    public ResponseEntity<AuthenticationResponse> authenticate(
            @RequestBody AuthenticationRequest request
    ) {
        return ResponseEntity.ok(authenticationService.authenticate(request));
    }
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\AuthenticationRequest.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class AuthenticationRequest {
    private String username;
    private String password;
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\AuthenticationResponse.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class AuthenticationResponse {
    private String token;
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\api\dto\RegisterRequest.java
============================================================

package com.bsuir.book_store.users.api.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class RegisterRequest {
    private String username;
    private String email;
    private String password;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\application\AuthenticationService.java
============================================================

package com.bsuir.book_store.users.application;

import com.bsuir.book_store.users.api.dto.AuthenticationRequest;
import com.bsuir.book_store.users.api.dto.AuthenticationResponse;
import com.bsuir.book_store.users.api.dto.RegisterRequest;
import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.domain.User;
import com.bsuir.book_store.users.infrastructure.UserRepository;
import com.bsuir.book_store.shared.security.JwtService;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class AuthenticationService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final JwtService jwtService;
    private final AuthenticationManager authenticationManager;

    public AuthenticationResponse register(RegisterRequest request) {
        var user = User.builder()
                .username(request.getUsername())
                .email(request.getEmail())
                .password(passwordEncoder.encode(request.getPassword()))
                .role(Role.CLIENT)
                .build();
        userRepository.save(user);

        var jwtToken = jwtService.generateToken(user);
        return AuthenticationResponse.builder()
                .token(jwtToken)
                .build();
    }

    public AuthenticationResponse authenticate(AuthenticationRequest request) {
        authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                        request.getUsername(),
                        request.getPassword()
                )
        );
        var user = userRepository.findByUsername(request.getUsername())
                .orElseThrow();

        var jwtToken = jwtService.generateToken(user);
        return AuthenticationResponse.builder()
                .token(jwtToken)
                .build();
    }
}


============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\domain\User.java
============================================================

package com.bsuir.book_store.users.domain;

import com.bsuir.book_store.catalog.domain.model.Book;
import com.bsuir.book_store.users.domain.enums.Role;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.sql.Timestamp;
import java.util.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "users")
public class User implements UserDetails {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(unique = true, nullable = false)
    private String username;

    @Column(nullable = false)
    private String password;

    @Column(unique = true, nullable = false)
    private String email;

    private String contactPhone;
    private String firstName;
    private String lastName;

    @Enumerated(EnumType.STRING)
    private Role role;

    @OneToMany(mappedBy = "user")
    private List<UserAddress> addresses;

    @ManyToMany
    @JoinTable(
            name = "wishlist_items",
            joinColumns = @JoinColumn(name = "user_id"),
            inverseJoinColumns = @JoinColumn(name = "book_id")
    )
    private Set<Book> wishlist = new HashSet<>();

    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private Timestamp createdAt;

    @UpdateTimestamp
    @Column(nullable = false)
    private Timestamp updatedAt;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return List.of(new SimpleGrantedAuthority(role.name()));
    }

    @Override
    public String getPassword() {
        return password;
    }

    @Override
    public String getUsername() {
        return username;
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\domain\UserAddress.java
============================================================

package com.bsuir.book_store.users.domain;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import java.sql.Timestamp;
import java.util.UUID;

@Entity
@Table(name = "user_addresses")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserAddress {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @ManyToOne
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @Column(name = "address_name")
    private String addressName;

    @Column(name = "address_text", columnDefinition = "TEXT", nullable = false)
    private String addressText;

    @Column(name = "is_default")
    private Boolean isDefault;

    @CreationTimestamp
    @Column(name = "created_at")
    private Timestamp createdAt;

    @UpdateTimestamp
    @Column(name = "updated_at")
    private Timestamp updatedAt;
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\domain\enums\Role.java
============================================================

package com.bsuir.book_store.users.domain.enums;

public enum Role {
    CLIENT,
    MANAGER
}

============================================================
FILE PATH: src\main\java\com\bsuir\book_store\users\infrastructure\UserRepository.java
============================================================

package com.bsuir.book_store.users.infrastructure;

import com.bsuir.book_store.users.domain.enums.Role;
import com.bsuir.book_store.users.domain.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Repository
public interface UserRepository extends JpaRepository<User, UUID> {
    Optional<User> findByUsername(String username);
    List<User> findByRole(Role role);
}


============================================================
FILE PATH: src\main\resources\application-docker.properties
============================================================

spring.datasource.url=jdbc:mysql://mysql-db:3306/book_store?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.elasticsearch.uris=http://elasticsearch:9201

============================================================
FILE PATH: src\main\resources\application-example.properties
============================================================

# =======================================
# ????? ????????? ??????????
# =======================================
spring.application.name=book-store

# =======================================
# ????????? ??????????? ? ???? ??????
# ???????? 'your_...' ?? ???? ????????? ??????
# =======================================
spring.datasource.url=jdbc:mysql://localhost:3306/your_database_name?useSSL=false
spring.datasource.username=your_database_username
spring.datasource.password=your_database_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# =======================================
# ????????? JPA / HIBERNATE
# =======================================
# ????????? Open Session In View, ??? ???????? ?????? ????????? ??? REST API
spring.jpa.open-in-view=false
# ??? ????????? ?????????? 'update' ????????? Hibernate ????????????? ?????????/????????? ???????
# ????????: ??? ?????????? ??????????? 'validate' ??? 'none'
spring.jpa.hibernate.ddl-auto=update
# ?????????? SQL-??????? ? ??????? (??????? ??? ???????)
spring.jpa.show-sql=true

# =======================================
# ????????? ???????????? (JWT)
# =======================================
# ???????????? ???? ??????????? ????????? ???? (????????, 256-?????? Base64)
application.security.jwt.secret-key=your_secret_jwt_key
# ????? ????? ?????? ? ????????????? (????? - 24 ????)
application.security.jwt.expiration=86400000

# =======================================
# ????????? ?? ?????????
# =======================================
# ?????? ??? ???????? ?????????, ??????? ????????? ??? ?????? ???????
manager.password=your_secure_manager_password

============================================================
FILE PATH: src\main\resources\application.properties
============================================================

spring.application.name=book-store

server.port=8081

spring.datasource.url=jdbc:mysql://localhost:3306/book_store?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.elasticsearch.uris=http://localhost:9201
spring.elasticsearch.connection-timeout=10s
spring.elasticsearch.socket-timeout=10s

spring.jpa.open-in-view=false
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true

application.security.jwt.secret-key=cHJldHR5aG9sbG93YWNjb3JkaW5nb3JhbmdlZ2lmdHdpc2VzdHJhbmdlc3RhaXJzdGU=
application.security.jwt.expiration=86400000

manager.password=manager

============================================================
FILE PATH: src\test\java\com\bsuir\book_store\BookStoreApplicationTests.java
============================================================

package com.bsuir.book_store;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class BookStoreApplicationTests {

	@Test
	void contextLoads() {
	}

}

